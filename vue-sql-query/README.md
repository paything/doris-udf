# Vue SQL Query - 漏斗分析与会话聚合

这是一个基于Vue 3和VisActor图表库的数据分析前端应用，专门用于Doris数据库的漏斗分析和会话聚合功能。

## 功能特性

### 漏斗分析 (WindowFunnel)
- **多模式支持**：default、backtrack、increase三种分析模式
- **灵活配置**：可配置时间窗口、最大步数、标记事件等参数
- **可视化展示**：
  - 漏斗图：展示各步骤的用户转化情况
  - 箱型图：展示各步骤的耗时分布统计
  - 数据表格：详细的统计结果数据

### 会话聚合 (SessionAgg)
- **多种标记模式**：start模式（正向构建）和end模式（逆序回数）
- **去重模式**：支持5种不同的去重策略
- **分组控制**：支持分组值数量限制和自定义替换值
- **可视化展示**：
  - 桑基图：展示用户路径流向
  - 数据表格：会话聚合结果

## 技术栈

- **前端框架**：Vue 3 (Composition API)
- **图表库**：VisActor VChart
- **表格组件**：VisActor VTable
- **构建工具**：Vite

## 项目结构

```
vue-sql-query/
├── src/
│   ├── App.vue          # 主应用组件
│   ├── main.js          # 应用入口
│   └── assets/          # 静态资源
├── public/              # 公共资源
├── package.json         # 依赖配置
└── README.md           # 项目说明
```

## 安装和运行

### 安装依赖
```bash
npm install
```

### 开发环境运行
```bash
npm run dev
```

### 生产环境构建
```bash
npm run build
```

## 使用说明

### 1. 漏斗分析
1. 在左侧参数面板配置漏斗分析参数：
   - **时间窗口(秒)**：分析的时间窗口大小
   - **最大步数**：漏斗的最大步骤数
   - **分析模式**：default/backtrack/increase
   - **标记事件**：开始分析的事件名称

2. 点击"查询"按钮执行分析

3. 查看结果：
   - 表格显示详细的统计结果
   - 漏斗图显示用户转化漏斗
   - 箱型图显示各步骤耗时分布

### 2. 会话聚合
1. 在左侧参数面板配置会话聚合参数：
   - **标记事件**：会话开始/结束的标记事件
   - **标记类型**：start（正向）或end（逆序）
   - **会话间隔(秒)**：会话超时时间
   - **会话模式**：去重策略选择

2. 点击"查询"按钮执行分析

3. 查看结果：
   - 表格显示会话聚合结果
   - 桑基图显示用户路径流向

## API配置

应用默认连接到本地5012端口的后端服务：
```javascript
const API_BASE_URL = `http://${window.location.hostname}:5012`;
```

如需修改API地址，请编辑`src/App.vue`中的`API_BASE_URL`配置。

## 数据格式

### 漏斗分析返回数据格式
```json
{
  "column_order": ["group0", "funnel_level", "value", "path_count", "avg_duration", "p0", "p25", "p50", "p75", "p90", "p100"],
  "data": [
    {
      "group0": "Total",
      "funnel_level": 1,
      "value": 100,
      "path_count": 100,
      "avg_duration": 5.2,
      "p0": 1,
      "p25": 3,
      "p50": 5,
      "p75": 7,
      "p90": 10,
      "p100": 15
    }
  ]
}
```

### 会话聚合返回数据格式
```json
{
  "column_order": ["e1", "value"],
  "data": [
    {
      "e1": "reg",
      "value": 50
    }
  ]
}
```

## 图表配置

### 漏斗图配置
- 自动计算转化率
- 支持标签显示
- 响应式布局

### 箱型图配置
- 显示最小值、Q1、中位数、Q3、最大值
- 支持异常值检测
- 自动计算IQR

### 桑基图配置
- 展示用户路径流向
- 支持节点和连接的自定义样式
- 交互式高亮

## 注意事项

1. **后端依赖**：需要确保Doris数据库和UDF函数已正确部署
2. **数据格式**：确保CSV数据格式符合要求，包含必要的字段
3. **网络配置**：确保前端能够访问后端API服务
4. **浏览器兼容性**：建议使用现代浏览器（Chrome、Firefox、Safari、Edge）

## 开发说明

### 添加新的图表类型
1. 在`transformFunnelData`或`transformSankeyData`函数中添加数据转换逻辑
2. 创建对应的渲染函数（如`renderNewChart`）
3. 在模板中添加图表容器
4. 添加相应的样式配置

### 修改SQL查询
1. 编辑`buildFunnelSQL`或`buildSessionSQL`函数
2. 根据需要调整参数绑定
3. 测试查询结果的正确性

### 自定义样式
1. 修改`<style scoped>`部分的CSS
2. 调整图表配置中的样式参数
3. 确保响应式布局的正确性

## 故障排除

### 常见问题
1. **图表不显示**：检查数据格式和图表配置
2. **API连接失败**：检查后端服务状态和网络配置
3. **参数验证错误**：确保参数类型和范围正确

### 调试技巧
1. 使用浏览器开发者工具查看网络请求
2. 检查控制台错误信息
3. 验证数据转换逻辑的正确性

## 更新日志

### v2.0.0 (当前版本)
- 完全重构为漏斗分析和会话聚合专用应用
- 集成VisActor图表库
- 支持多种分析模式和可视化图表
- 优化用户界面和交互体验

### v1.0.0
- 初始版本，支持基础SQL查询功能
