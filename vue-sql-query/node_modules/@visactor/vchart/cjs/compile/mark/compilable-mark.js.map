{"version":3,"sources":["../src/compile/mark/compilable-mark.ts"],"names":[],"mappings":"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","file":"compilable-mark.js","sourcesContent":["import type {\n  IData,\n  IElement,\n  IGroupMark,\n  IMark,\n  IMarkConfig,\n  MarkAnimationSpec,\n  MarkFunctionCallback,\n  MarkFunctionType,\n  Nil,\n  TransformSpec\n} from '@visactor/vgrammar-core';\n// eslint-disable-next-line no-duplicate-imports\nimport type { GrammarMarkType } from '@visactor/vgrammar-core';\nimport type { DataView } from '@visactor/vdataset';\nimport { GrammarItem } from '../grammar-item';\nimport type { Maybe, Datum, StringOrNumber } from '../../typings';\nimport { isNil, isValid } from '@visactor/vutils';\nimport { VGRAMMAR_HOOK_EVENT } from '../../constant/event';\nimport { PREFIX } from '../../constant/base';\nimport { LayoutZIndex } from '../../constant/layout';\nimport type { IMarkStateStyle, MarkType } from '../../mark/interface';\nimport type { IModel } from '../../model/interface';\nimport type { ISeries } from '../../series/interface';\nimport { isStateAttrChangeable } from './util';\nimport { MarkStateManager } from './mark-state-manager';\nimport type {\n  ICompilableMark,\n  IMarkDataInitOption,\n  ICompilableMarkOption,\n  StateValueType,\n  IMarkCompileOption,\n  IAttributeOpt,\n  IMarkData\n} from './interface';\n// eslint-disable-next-line no-duplicate-imports\nimport { STATE_VALUE_ENUM } from './interface';\nimport { MarkData } from './mark-data';\nimport { GrammarType } from '../interface/compilable-item';\nimport type { IComponent } from '../../component/interface';\nimport type { IEvent } from '../../event/interface';\nimport { Event } from '../../event/event';\n// eslint-disable-next-line no-duplicate-imports\nimport { AnimationStateEnum } from '../../animation/interface';\n\n/** 可编译的 mark 对象，这个基类只存放编译相关的逻辑 */\nexport abstract class CompilableMark extends GrammarItem implements ICompilableMark {\n  readonly grammarType = GrammarType.mark;\n  /** 类型 */\n  readonly type: MarkType = undefined as unknown as MarkType;\n\n  /** name */\n  readonly name: string = 'mark';\n\n  /** key field */\n  readonly key: ICompilableMark['key'];\n\n  protected _markConfig: IMarkConfig = {\n    zIndex: LayoutZIndex.Mark,\n    /** morph动画关联关系配置 */\n    morph: false\n  };\n\n  getMarkConfig(): IMarkConfig {\n    return this._markConfig;\n  }\n  setMarkConfig(config: IMarkConfig) {\n    Object.keys(config).forEach(key => {\n      (this._markConfig as any)[key] = (config as any)[key];\n    });\n  }\n\n  /** 可见性 */\n  protected _visible: boolean = true;\n  getVisible() {\n    return this._visible;\n  }\n  setVisible(visible: boolean) {\n    this._visible = visible;\n  }\n\n  /**\n   * 用户设置的 id\n   */\n  protected _userId: StringOrNumber;\n  getUserId() {\n    return this._userId;\n  }\n  setUserId(userId: StringOrNumber) {\n    if (isValid(userId)) {\n      this._userId = userId;\n    }\n  }\n\n  /** parent model */\n  readonly model: IModel;\n\n  /** 数据（可以没有） */\n  protected _data: IMarkData;\n  getDataView(): DataView | undefined {\n    return this._data?.getDataView();\n  }\n  setDataView(d?: DataView, productId?: string) {\n    if (isNil(this._data)) {\n      this.initMarkData({\n        ...this._option,\n        mark: this\n      });\n    }\n    if (isValid(productId)) {\n      this._data.setCompiledProductId(productId);\n    }\n    this._data.setDataView(d);\n  }\n  getData() {\n    return this._data;\n  }\n  setData(d?: IMarkData) {\n    this._data = d;\n  }\n\n  /** 默认的stateStyle */\n  stateStyle: IMarkStateStyle<any> = {};\n\n  /** 状态管理器 */\n  state: MarkStateManager;\n\n  protected _unCompileChannel: { [key in string]: boolean } = {};\n\n  hasState(state: string) {\n    return state in this.state.getStateMap();\n  }\n  getState(state: string) {\n    return this.state.getStateMap()[state];\n  }\n\n  protected _event: IEvent;\n\n  protected _animationConfig: Partial<MarkAnimationSpec>;\n  getAnimationConfig() {\n    return this._animationConfig;\n  }\n  setAnimationConfig(config: Partial<MarkAnimationSpec>) {\n    this._animationConfig = config;\n  }\n\n  /** 布局标记 */\n  private _skipBeforeLayouted = false;\n\n  setSkipBeforeLayouted(skip: boolean) {\n    this._skipBeforeLayouted = skip;\n  }\n  getSkipBeforeLayouted(): boolean {\n    return this._skipBeforeLayouted;\n  }\n\n  protected _groupKey?: string;\n  getGroupKey() {\n    return this._groupKey;\n  }\n  setGroupKey(groupKey: string) {\n    this._groupKey = groupKey;\n  }\n\n  protected _stateSort?: (stateA: string, stateB: string) => number;\n  setStateSortCallback(stateSort: (stateA: string, stateB: string) => number) {\n    this._stateSort = stateSort;\n  }\n\n  protected declare _option: ICompilableMarkOption;\n\n  constructor(option: ICompilableMarkOption, name: string, model: IModel) {\n    super(option);\n    this.name = name;\n    this.model = model;\n    this.key = option.key;\n    this.state = new MarkStateManager(\n      {\n        ...option,\n        stateKeyToSignalName: this.stateKeyToSignalName.bind(this)\n      },\n      this\n    );\n    this._event = new Event(model.getOption().eventDispatcher, model.getOption().mode);\n  }\n\n  protected declare _product: Maybe<IMark>;\n  declare getProduct: () => Maybe<IMark>;\n\n  // transform目前在形状词云中使用，但直接用的 vgrammar 接口 (this._wordMark as ICompilableMark).getProduct().transform(wordCloudTransforms);\n  // 暂时没有用到这里的setTransform()\n  protected _transform: TransformSpec[] | Nil;\n  setTransform(transform: TransformSpec[] | Nil) {\n    this._transform = transform;\n  }\n\n  /** 初始化 mark data */\n  protected initMarkData(option: IMarkDataInitOption) {\n    this._data = new MarkData(option);\n  }\n\n  protected stateKeyToSignalName(key: string) {\n    return `${PREFIX}_${this.type}_${this.id}_${key}`;\n  }\n\n  getAttribute(key: any, datum: any, state: StateValueType, opt?: IAttributeOpt) {\n    // do nothing\n  }\n\n  protected _compileProduct(option?: IMarkCompileOption) {\n    const product = this.getProduct();\n    // 处理 visible 为 false 的情况\n    if (!this.getVisible()) {\n      if (isValid(product)) {\n        this.removeProduct();\n      }\n      return;\n    } else if (isValid(product)) {\n      return; // 每个mark只执行一次编译\n    }\n\n    const compiler = this.getCompiler();\n    if (!compiler.isInited) {\n      return;\n    }\n    this._initProduct(option?.group);\n    if (isNil(this._product)) {\n      return;\n    }\n\n    this.compileSignal();\n    this.compileData();\n    this.compileState();\n    this.compileEncode();\n    this.compileAnimation();\n    this.compileContext(option?.context);\n    this.compileTransform();\n  }\n\n  /** 创建语法元素对象 */\n  protected _initProduct(group?: string | IGroupMark) {\n    const view = this.getVGrammarView();\n\n    // 声明语法元素\n    const id = this.getProductId();\n    this._product = view.mark(this.type as GrammarMarkType, group ?? view.rootMark).id(id);\n    if (this.name && this._product) {\n      this._product.name(this.name);\n    }\n    this._compiledProductId = id;\n  }\n\n  generateProductId() {\n    if (this._userId) {\n      return `${this._userId}`;\n    }\n    return `${this.name}_${this.id}`;\n  }\n\n  compileData() {\n    if (isNil(this._data)) {\n      return;\n    }\n    this._data.compile();\n\n    // 绑定数据\n    const dataProduct = this._data.getProduct();\n    if (isValid(this._product) && isValid(dataProduct)) {\n      this._product.join(dataProduct as IData, this.key, undefined, this.getGroupKey());\n    }\n  }\n\n  updateStaticEncode() {\n    if (!this._product) {\n      return;\n    }\n    const { enterStyles, updateStyles } = this._separateStyle();\n\n    this._product.encodeState('group', enterStyles, true);\n\n    this._product.encode(updateStyles, true);\n  }\n\n  protected _separateStyle() {\n    const { [STATE_VALUE_ENUM.STATE_NORMAL]: normalStyle, ...temp } = this.stateStyle;\n\n    const enterStyles: Record<string, MarkFunctionType<any>> = this._option.noSeparateStyle ? null : {};\n    const updateStyles: Record<string, MarkFunctionType<any>> = {};\n    Object.keys(normalStyle).forEach(key => {\n      if (this._unCompileChannel[key]) {\n        return;\n      }\n\n      if (this._option.noSeparateStyle || isStateAttrChangeable(key, normalStyle, this.getGroupKey())) {\n        updateStyles[key] = {\n          callback: this.compileCommonAttributeCallback(key, 'normal'),\n          dependency: [this.stateKeyToSignalName('markUpdateRank')]\n        };\n      } else {\n        enterStyles[key] = this.compileCommonAttributeCallback(key, 'normal');\n      }\n    });\n    return { enterStyles, updateStyles };\n  }\n\n  compileEncode() {\n    const { [STATE_VALUE_ENUM.STATE_NORMAL]: normalStyle, ...temp } = this.stateStyle;\n    const { enterStyles, updateStyles } = this._separateStyle();\n    this._product.encode(updateStyles, true);\n    this._product.encodeState('group', enterStyles, true);\n\n    Object.keys(temp).forEach(state => {\n      const styles: Record<string, MarkFunctionType<any>> = {};\n      Object.keys(temp[state]).forEach(key => {\n        if (this._unCompileChannel[key]) {\n          return;\n        }\n        styles[key] = {\n          callback: this.compileCommonAttributeCallback(key, state),\n          dependency: [this.stateKeyToSignalName('markUpdateRank')]\n        };\n      });\n      this._product.encodeState(state, styles, true);\n    });\n\n    // 在布局完成前不进行encode\n    if (this._skipBeforeLayouted) {\n      this._product.layout({\n        skipBeforeLayouted: this._skipBeforeLayouted\n      });\n    }\n  }\n\n  compileState() {\n    this.state.compileState(this._product, this._stateSort);\n  }\n\n  compileAnimation() {\n    if (this._animationConfig) {\n      let stateSignal: any;\n      if (this.type === 'component') {\n        // 组件有自己的动画状态\n        stateSignal = (this.model as IComponent).animate?.getAnimationStateSignalName();\n      } else {\n        const region = (this.model as ISeries).getRegion?.();\n        stateSignal = region?.animate?.getAnimationStateSignalName();\n      }\n      this._product.animation(this._animationConfig);\n      this._product.animationState({\n        callback: (datum: Datum, element: IElement, parameters: Record<string, any>) => {\n          return parameters[stateSignal]?.callback(datum, element);\n        },\n        dependency: stateSignal\n      });\n      if (this._animationConfig.normal) {\n        if (!this._animationConfig.appear) {\n          this._event.on(VGRAMMAR_HOOK_EVENT.AFTER_DO_RENDER, () => {\n            this.runAnimationByState(AnimationStateEnum.normal);\n          });\n        } else {\n          this._event.on(VGRAMMAR_HOOK_EVENT.ANIMATION_END, ({ event }) => {\n            if (event.mark === this.getProduct() && event.animationState === AnimationStateEnum.appear) {\n              this.runAnimationByState(AnimationStateEnum.normal);\n            }\n          });\n        }\n      }\n    }\n  }\n\n  compileContext(extraContext?: any) {\n    const config: IMarkConfig = {\n      ...this._markConfig,\n      context: {\n        markId: this.id,\n        modelId: this.model.id,\n        markUserId: this._userId,\n        modelUserId: this.model.userId,\n        ...extraContext\n      }\n    };\n    this._product.configure(config);\n  }\n\n  compileSignal() {\n    this.state.compile();\n  }\n\n  protected _computeAttribute(key: string, state: StateValueType) {\n    return (datum: Datum, opt: IAttributeOpt) => {\n      return undefined as any;\n    };\n  }\n\n  // TODO: 1. opt内容待定，确实需要再来补充（之前是scale.bindScales/bindSignals，从context.params中可以获取到）\n  // TODO: 2. stateSourceItem，是否根据attr区分，存在默认写死的情况，例如\"hover\"/\"normal\"；\n  protected compileCommonAttributeCallback(key: string, state: string): MarkFunctionCallback<any> {\n    const attributeFunctor = this._computeAttribute(key, state);\n    // remove state in opt\n    const opt: IAttributeOpt = { mark: null, parent: null, element: null };\n    return (datum: Datum, element: IElement) => {\n      opt.mark = element.mark;\n      opt.parent = element.mark.group;\n      opt.element = element;\n      return attributeFunctor(datum, opt);\n    };\n  }\n\n  protected compileTransform() {\n    if (this._transform?.length) {\n      this.getProduct().transform(this._transform);\n    }\n  }\n\n  protected _lookupGrammar(id: string) {\n    return this.getCompiler().getVGrammarView()?.getMarkById(id);\n  }\n\n  updateState(newState: Record<string, unknown>, noRender?: boolean) {\n    return this.state.updateState(newState, noRender);\n  }\n\n  updateLayoutState(noRender?: boolean, recursion?: boolean): void {\n    if (recursion && this.getMarks().length > 0) {\n      this.getMarks().forEach(m => m.state.updateLayoutState(true));\n    }\n    return this.state.updateLayoutState(noRender);\n  }\n\n  updateMarkState(key: string): void {\n    if (!this._product) {\n      return;\n    }\n    const stateInfo = this.state.getStateInfo(key);\n    this._product.elements.forEach(e => {\n      if (this.state.checkOneState(e, e.getDatum(), stateInfo) === 'in') {\n        e.addState(key);\n      } else {\n        e.removeState(key);\n      }\n    });\n  }\n\n  getMarks(): ICompilableMark[] {\n    return [];\n  }\n\n  runAnimationByState(state?: string) {\n    return this.getProduct()?.animate?.runAnimationByState(state);\n  }\n\n  stopAnimationByState(state?: string) {\n    return this.getProduct()?.animate?.stopAnimationByState(state);\n  }\n\n  pauseAnimationByState(state?: string) {\n    return this.getProduct()?.animate?.pauseAnimationByState(state);\n  }\n\n  resumeAnimationByState(state?: string) {\n    return this.getProduct()?.animate?.resumeAnimationByState(state);\n  }\n\n  getProductElements() {\n    const product = this.getProduct();\n    if (product) {\n      return product.elements;\n    }\n    return undefined;\n  }\n\n  clear() {\n    this._event.off(VGRAMMAR_HOOK_EVENT.AFTER_DO_RENDER);\n  }\n\n  release() {\n    super.release();\n    this.state.release();\n  }\n}\n"]}