{"version":3,"sources":["../src/compile/compiler.ts"],"names":[],"mappings":"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","file":"compiler.js","sourcesContent":["import { ChartEvent, Event_Source_Type } from './../constant/event';\nimport type { IElement, InteractionSpec, IView } from '@visactor/vgrammar-core';\n// eslint-disable-next-line no-duplicate-imports\nimport { View } from '@visactor/vgrammar-core';\nimport type {\n  CompilerListenerParameters,\n  ICompiler,\n  ICompilerModel,\n  IGrammarItem,\n  IProductMap,\n  IRenderContainer,\n  IRenderOption\n} from './interface';\n// eslint-disable-next-line no-duplicate-imports\nimport { GrammarType } from './interface/compilable-item';\nimport { toRenderMode } from './util';\nimport { isMobileLikeMode, isTrueBrowser } from '../util/env';\nimport { isString } from '../util/type';\nimport type { IBoundsLike } from '@visactor/vutils';\n// eslint-disable-next-line no-duplicate-imports\nimport { isNil, isValid, Logger, LoggerLevel } from '@visactor/vutils';\nimport type { EventSourceType } from '../event/interface';\nimport type { IChart } from '../chart/interface';\nimport { vglobal } from '@visactor/vrender-core';\nimport type { IColor, IStage } from '@visactor/vrender-core';\nimport type { IMorphConfig } from '../animation/spec';\nimport type { IVChart } from '../core/interface';\n\ntype EventListener = {\n  type: string;\n  callback: (...args: any[]) => void;\n};\n\nexport class Compiler implements ICompiler {\n  protected _view: IView;\n  /**\n   * 获取 VGrammar View 实例\n   */\n  getVGrammarView() {\n    return this._view;\n  }\n  protected _viewListeners: Map<(...args: any[]) => any, EventListener> = new Map();\n  protected _windowListeners: Map<(...args: any[]) => any, EventListener> = new Map();\n  protected _canvasListeners: Map<(...args: any[]) => any, EventListener> = new Map();\n\n  isInited: boolean = false;\n\n  private _nextRafId: number;\n\n  protected _width: number;\n  protected _height: number;\n\n  protected _container: IRenderContainer;\n  protected _option: IRenderOption;\n  // 已释放标记\n  private _released: boolean = false;\n\n  protected _model: ICompilerModel = {\n    [GrammarType.signal]: {},\n    [GrammarType.data]: {},\n    [GrammarType.mark]: {}\n  };\n\n  protected _interactions: (InteractionSpec & { seriesId?: number; regionId?: number })[];\n  getModel() {\n    return this._model;\n  }\n\n  private _compileChart: IChart = null;\n\n  constructor(container: IRenderContainer, option: IRenderOption) {\n    this._container = container;\n    this._option = option;\n  }\n\n  getRenderer() {\n    return this._view?.renderer;\n  }\n\n  /**\n   * 获取 canvas dom\n   * @returns HTMLCanvasElement | undefined\n   */\n  getCanvas(): HTMLCanvasElement | undefined {\n    return this._view?.renderer.canvas();\n  }\n\n  /**\n   * 获取 渲染引擎\n   */\n  getStage(): IStage | undefined {\n    return this._view?.renderer.stage() as unknown as IStage;\n  }\n\n  initView() {\n    if (this._released) {\n      return;\n    }\n    this.isInited = true;\n    if (this._view) {\n      return;\n    }\n    const logger = new Logger(this._option.logLevel ?? LoggerLevel.Error);\n    if (this._option?.onError) {\n      logger.addErrorHandler((...args) => {\n        this._option?.onError?.(...args);\n      });\n    }\n    const {\n      performanceHook,\n      autoRefreshDpr,\n      dpr,\n      mode,\n      gestureConfig,\n      interactive,\n      clickInterval,\n      autoPreventDefault,\n      ...restOption\n    } = this._option;\n    this._view = new View({\n      width: this._width,\n      height: this._height,\n      container: this._container.dom ?? null,\n      renderCanvas: this._container.canvas ?? null,\n      hooks: performanceHook, // vgrammar 事件改造后，性能回调函数放在了hooks中实现\n      ...restOption,\n      dpr,\n      autoRefresh: isValid(autoRefreshDpr) ? autoRefreshDpr : !isValid(dpr),\n      mode: toRenderMode(mode),\n      autoFit: false,\n      eventConfig: {\n        gesture: isValid(gestureConfig) ? (gestureConfig as any) : isMobileLikeMode(mode),\n        disable: interactive === false,\n        clickInterval,\n        autoPreventDefault\n      },\n      doLayout: () => {\n        this._compileChart?.onLayout(this._view);\n      },\n      logger: logger,\n      logLevel: logger.level()\n    });\n    this._setCanvasStyle();\n\n    // emit afterRender event\n    this.getStage().hooks.afterRender.tap('chart-event', this.handleStageRender);\n\n    if (interactive !== false) {\n      // 将 view 实例化之前监听的事件挂载到 view 上\n      this._viewListeners.forEach(listener => {\n        this._view?.addEventListener(listener.type, listener.callback);\n      });\n    }\n  }\n\n  protected handleStageRender = () => {\n    this._compileChart?.getEvent()?.emit(ChartEvent.afterRender, { chart: this._compileChart });\n  };\n\n  private _setCanvasStyle() {\n    if (!this._view) {\n      return;\n    }\n    if (this._container.dom && !isString(this._container.dom)) {\n      this._container.dom.style.display = 'block';\n      this._container.dom.style.position = 'relative';\n      const canvas = this.getCanvas();\n      if (canvas) {\n        canvas.style.display = 'block';\n      }\n    }\n  }\n\n  protected compileInteractions() {\n    this._view.removeAllInteractions();\n    if (this._interactions?.length) {\n      const regionCombindInteractions = {};\n\n      this._interactions.forEach(interaction => {\n        if (interaction.regionId) {\n          const interactionId = `${interaction.regionId}-${interaction.type}-${interaction.id ?? ''}`;\n          const spec = regionCombindInteractions[interactionId];\n          if (spec) {\n            regionCombindInteractions[interactionId] = {\n              ...spec,\n              ...interaction,\n              selector: [...spec.selector, ...(interaction as any).selector]\n            };\n          } else {\n            regionCombindInteractions[interactionId] = interaction;\n          }\n        } else {\n          this._view.interaction(interaction.type, interaction);\n        }\n      });\n\n      Object.keys(regionCombindInteractions).forEach(key => {\n        const interaction = this._view.interaction(regionCombindInteractions[key].type, regionCombindInteractions[key]);\n        if (this._compileChart) {\n          const region = this._compileChart.getRegionsInIds([regionCombindInteractions[key].regionId])[0];\n          if (region) {\n            region.interaction.addVgrammarInteraction(interaction.getStartState(), interaction);\n          }\n        }\n      });\n    }\n  }\n\n  compile(ctx: { chart: IChart; vChart: IVChart }, option: any) {\n    if (this._released) {\n      return;\n    }\n    const { chart } = ctx;\n    this._compileChart = chart;\n    this.initView();\n    if (!this._view) {\n      return;\n    }\n\n    chart.compile();\n    chart.afterCompile();\n    this.updateDepend();\n\n    this.compileInteractions();\n  }\n  protected clearNextRender() {\n    if (this._nextRafId) {\n      vglobal.getCancelAnimationFrame()(this._nextRafId);\n      this._nextRafId = null;\n\n      return true;\n    }\n\n    return false;\n  }\n\n  clear(ctx: { chart: IChart; vChart: IVChart }, removeGraphicItems: boolean = false) {\n    const { chart } = ctx;\n\n    this.clearNextRender();\n    chart.clear();\n    this.releaseGrammar(removeGraphicItems);\n  }\n\n  renderNextTick(morphConfig?: IMorphConfig): void {\n    if (this._released) {\n      return;\n    }\n    if (!this._nextRafId) {\n      this._nextRafId = vglobal.getRequestAnimationFrame()(() => {\n        this._nextRafId = null;\n        this.render(morphConfig);\n      }) as unknown as number;\n    }\n  }\n\n  render(morphConfig?: IMorphConfig) {\n    if (this._released) {\n      return;\n    }\n\n    this.initView();\n    if (!this._view) {\n      return;\n    }\n    this._view?.run(morphConfig);\n    if (this.clearNextRender()) {\n      this._view?.run(morphConfig);\n    }\n  }\n\n  updateViewBox(viewBox: IBoundsLike, reRender: boolean = true) {\n    if (!this._view) {\n      return;\n    }\n\n    this._view.renderer.setViewBox(viewBox, reRender);\n  }\n\n  resize(width: number, height: number, reRender: boolean = true) {\n    if (!this._view) {\n      return;\n    }\n    this._width = width;\n    this._height = height;\n\n    this._view.resize(width, height);\n    if (reRender) {\n      this.render({ morph: false });\n    }\n  }\n\n  setBackground(color: IColor) {\n    this._view?.background(color);\n  }\n\n  setSize(width: number, height: number) {\n    this._width = width;\n    this._height = height;\n    if (!this._view) {\n      return;\n    }\n\n    this._view.width(width);\n    this._view.height(height);\n  }\n\n  setViewBox(viewBox: IBoundsLike, reRender: boolean = true) {\n    if (!this._view) {\n      return;\n    }\n\n    this._view.renderer.setViewBox(viewBox, reRender);\n  }\n\n  addEventListener(\n    source: EventSourceType,\n    type: string,\n    callback: (params: CompilerListenerParameters) => void\n  ): void {\n    // TODO: 需要明确一下 interactive 的作用范围，同时考虑是否存在非交互行为的事件以及是否需要生效\n    if (this._option.interactive === false) {\n      return;\n    }\n    if (source === Event_Source_Type.chart) {\n      const wrappedCallback = function (event: any, element: IElement | null) {\n        const context = element?.mark?.getContext() ?? {};\n        const modelId = isValid(context.modelId) ? context.modelId : null;\n        const markId = isValid(context.markId) ? context.markId : null;\n        const modelUserId = isValid(context.modelUserId) ? context.modelUserId : null;\n        const markUserId = isValid(context.markUserId) ? context.markUserId : null;\n\n        const params: CompilerListenerParameters = {\n          event,\n          type,\n          source,\n          item: element,\n          datum: element?.getDatum?.() || null,\n          markId,\n          modelId,\n          markUserId,\n          modelUserId\n        };\n        callback.call(null, params);\n      }.bind(this);\n      this._viewListeners.set(callback, { type, callback: wrappedCallback });\n      // 如果 view 已经初始化则立刻挂载监听\n      // FIXME: 目前 vgrammar 类型声明没有对齐，事件相关类型声明并没有使用 SceneItem\n      this._view?.addEventListener(type, wrappedCallback as any);\n    } else if (source === Event_Source_Type.window) {\n      const wrappedCallback = function wrappedCallback(event: any) {\n        // TODO: vgrammar 暂未提供基于事件直接筛选相应 mark 的能力，这里无法获取到相应的 item\n        const params: CompilerListenerParameters = {\n          event,\n          type,\n          source,\n          item: null,\n          datum: null,\n          markId: null,\n          modelId: null,\n          markUserId: null,\n          modelUserId: null\n        };\n        callback.call(null, params);\n      }.bind(this);\n      this._windowListeners.set(callback, { type, callback: wrappedCallback });\n      const windowObject = this._getGlobalThis();\n      windowObject?.addEventListener(type, wrappedCallback);\n    } else if (source === Event_Source_Type.canvas) {\n      const wrappedCallback = function wrappedCallback(event: any) {\n        // TODO: vgrammar 暂未提供基于事件直接筛选相应 mark 的能力，这里无法获取到相应的 item\n        const params: CompilerListenerParameters = {\n          event,\n          type,\n          source,\n          item: null,\n          datum: null,\n          markId: null,\n          modelId: null,\n          markUserId: null,\n          modelUserId: null\n        };\n        callback.call(null, params);\n      }.bind(this);\n      this._canvasListeners.set(callback, { type, callback: wrappedCallback });\n      const canvasObject = this.getStage()?.window;\n      canvasObject?.addEventListener(type, wrappedCallback);\n    }\n  }\n\n  removeEventListener(\n    source: EventSourceType,\n    type: string,\n    callback: (params: CompilerListenerParameters) => void\n  ): void {\n    if (this._option.interactive === false) {\n      return;\n    }\n    if (source === Event_Source_Type.chart) {\n      const wrappedCallback = this._viewListeners.get(callback)?.callback;\n      wrappedCallback && this._view?.removeEventListener(type, wrappedCallback);\n      this._viewListeners.delete(callback);\n    } else if (source === Event_Source_Type.window) {\n      const windowObject = this._getGlobalThis();\n      const wrappedCallback = this._windowListeners.get(callback)?.callback;\n      wrappedCallback && windowObject?.removeEventListener(type, wrappedCallback);\n      this._windowListeners.delete(callback);\n    } else if (source === Event_Source_Type.canvas) {\n      const canvasObject = this.getStage()?.window;\n      const wrappedCallback = this._canvasListeners.get(callback)?.callback;\n      canvasObject && wrappedCallback && canvasObject?.removeEventListener(type, wrappedCallback);\n      this._canvasListeners.delete(callback);\n    }\n  }\n\n  protected releaseEvent(): void {\n    const stage = this.getStage();\n\n    if (stage) {\n      stage.hooks.afterRender.unTap('chart-event', this.handleStageRender);\n    }\n\n    // 相应的事件remove在model中完成\n    this._viewListeners.clear();\n    this._windowListeners.clear();\n    this._canvasListeners.clear();\n  }\n\n  release(): void {\n    this.clearNextRender();\n    this.releaseEvent();\n    this._option = this._container = null as any;\n    // vgrammar release\n    this._releaseModel();\n    this._view?.release();\n    this._view = null;\n    this.isInited = false;\n    this._compileChart = null;\n    this._released = true;\n  }\n\n  /**\n   * 释放VGrammar\n   * @param removeGraphicItems 是否删除场景元素，在同步渲染，并且无动画时，必须设置为true，否则有绘图残留\n   */\n  releaseGrammar(removeGraphicItems: boolean = false) {\n    this._releaseModel();\n    if (removeGraphicItems) {\n      this._view?.removeAllGraphicItems();\n    }\n    this._view?.removeAllGrammars();\n  }\n\n  protected _releaseModel() {\n    // 释放model\n    Object.keys(this._model).forEach(type => {\n      Object.values(this._model[type] as IProductMap<IGrammarItem>).forEach(grammarItemMap => {\n        Object.values(grammarItemMap).forEach((item: IGrammarItem) => {\n          item.removeProduct(true); // 保留 vgrammar 语法元素，下面一起清空\n        });\n      });\n      this._model[type] = {};\n    });\n  }\n\n  /** 添加语法元素 */\n  addGrammarItem(grammarItem: IGrammarItem) {\n    const product = grammarItem.getProduct();\n    if (isNil(product)) {\n      return;\n    }\n    const id = product.id();\n    const type = grammarItem.grammarType;\n    if (isNil(this._model[type][id])) {\n      this._model[type][id] = {};\n    }\n    this._model[type][id][grammarItem.id] = grammarItem;\n  }\n\n  /** 删除语法元素 */\n  removeGrammarItem(grammarItem: IGrammarItem, reserveVGrammarModel?: boolean) {\n    const product = grammarItem.getProduct();\n    if (isNil(product)) {\n      return;\n    }\n    const id = product.id();\n    const type = grammarItem.grammarType;\n    const map = this._model[type][id];\n    if (isValid(map)) {\n      delete map[grammarItem.id];\n      if (Object.keys(map).length === 0) {\n        delete this._model[type][id];\n      }\n    }\n    if (!reserveVGrammarModel) {\n      this._view?.removeGrammar(product);\n    }\n  }\n\n  addInteraction(interaction: InteractionSpec & { seriesId?: number; regionId?: number }) {\n    if (!this._interactions) {\n      this._interactions = [];\n    }\n\n    this._interactions.push(interaction);\n  }\n\n  removeInteraction(seriesId: number) {\n    if (!this._interactions) {\n      return;\n    }\n\n    this._interactions = this._interactions.filter(entry => entry.seriesId !== seriesId);\n  }\n\n  /** 更新语法元素间的依赖关系，返回是否全部成功更新 */\n  updateDepend(items?: IGrammarItem[]): boolean {\n    if (isValid(items) && items.length > 0) {\n      // 局部更新依赖\n      return items.every(item => item.updateDepend());\n    }\n    // 全局更新依赖\n    Object.values(this._model).forEach(productMap => {\n      Object.values(productMap).forEach(grammarItemMap => {\n        const grammarItems = Object.values(grammarItemMap) as IGrammarItem[];\n        // 获取编译产物\n        const product = grammarItems[0].getProduct();\n\n        // 获取编译产物的依赖项\n        const dependList = grammarItems\n          .reduce((depend, item) => {\n            if (item.getDepend().length > 0) {\n              return depend.concat(item.getDepend());\n            }\n            return depend;\n          }, [] as IGrammarItem[])\n          .filter(grammarItem => !!grammarItem)\n          .map(grammarItem => grammarItem.getProduct());\n\n        // 更新依赖\n        product.depend(dependList);\n      });\n    });\n    return true;\n  }\n\n  private _getGlobalThis() {\n    return isTrueBrowser(this._option.mode) ? globalThis : this.getStage()?.window;\n  }\n}\n"]}