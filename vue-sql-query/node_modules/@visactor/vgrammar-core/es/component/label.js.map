{"version":3,"sources":["../src/component/label.ts"],"names":[],"mappings":"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","file":"label.js","sourcesContent":["import { array, isNil, isString, merge } from '@visactor/vutils';\nimport type { IGraphic } from '@visactor/vrender-core';\nimport type { BaseLabelAttrs, DataLabelAttrs } from '@visactor/vrender-components';\n// eslint-disable-next-line no-duplicate-imports\nimport { DataLabel } from '@visactor/vrender-components';\nimport type {\n  BaseSingleEncodeSpec,\n  IElement,\n  IGroupMark,\n  IMark,\n  ITheme,\n  IView,\n  MarkFunctionType,\n  Nil,\n  StateEncodeSpec\n} from '../types';\nimport { ComponentEnum, GrammarMarkType } from '../graph/enums';\nimport type { ILabel, LabelSpec } from '../types/component';\nimport { Component } from '../view/component';\nimport { invokeEncoder } from '../graph/mark/encode';\nimport { invokeFunctionType } from '../parse/util';\nimport { Factory } from '../core/factory';\n\nexport const generateLabelAttributes = (\n  marks: IMark[],\n  groupSize: { width: number; height: number },\n  encoder: BaseSingleEncodeSpec,\n  labelStyle: MarkFunctionType<Partial<BaseLabelAttrs>>,\n  parameters: any,\n  theme: ITheme = {}\n): DataLabelAttrs => {\n  const labelTheme = theme.components?.dataLabel;\n  const dataLabels = marks\n    .map((mark, index) => {\n      const labelParameters = { ...parameters, labelIndex: index };\n      const addition = invokeFunctionType(labelStyle, labelParameters, mark) ?? {};\n      const { components = {} } = theme;\n      let currentTheme: any = {};\n\n      switch (mark.markType) {\n        case GrammarMarkType.line:\n        case GrammarMarkType.area:\n          if (addition.type === 'line') {\n            currentTheme = components.lineLabel;\n          } else if (addition.type === 'area') {\n            currentTheme = components.areaLabel;\n          } else {\n            currentTheme = components.lineDataLabel;\n          }\n          break;\n        case GrammarMarkType.rect:\n        case GrammarMarkType.rect3d:\n        case GrammarMarkType.interval:\n          currentTheme = components.rectLabel;\n          break;\n        case GrammarMarkType.symbol:\n        case GrammarMarkType.circle:\n        case GrammarMarkType.cell:\n          currentTheme = components.symbolLabel;\n          break;\n        case GrammarMarkType.arc:\n        case GrammarMarkType.arc3d:\n          currentTheme = components.arcLabel;\n          break;\n        case GrammarMarkType.polygon:\n        case GrammarMarkType.path:\n        default:\n          currentTheme = components.pointLabel;\n          break;\n      }\n\n      const data: any[] = addition.data ?? [];\n      const themeDatum = currentTheme?.data?.[0] ?? {};\n      if (data && data.length > 0) {\n        data.forEach((d, index) => {\n          if (mark.elements[index]) {\n            const attributes = invokeEncoder(encoder, d, mark.elements[index], labelParameters);\n            merge(d, themeDatum, attributes);\n          }\n        });\n      } else {\n        const mergeAttributes = (attributes: any, themeDatum: any) => {\n          const { data: labelData, ...restAttribute } = attributes;\n          return { ...merge({}, themeDatum, restAttribute), data: labelData };\n        };\n        // process by order of elements\n        mark.elements.forEach(element => {\n          const graphicItem = element.getGraphicItem();\n          if ((graphicItem as any).releaseStatus !== 'willRelease') {\n            if (mark.isCollectionMark()) {\n              const datum = element.getDatum();\n\n              datum.forEach((entry: any) => {\n                const attributes = invokeEncoder(encoder, entry, element, labelParameters);\n                data.push(mergeAttributes(attributes, themeDatum));\n              });\n            } else {\n              const attributes = invokeEncoder(encoder, element.getDatum(), element, labelParameters);\n              data.push(mergeAttributes(attributes, themeDatum));\n            }\n          }\n        });\n      }\n\n      const graphicItemName = mark.graphicItem?.name;\n      const result = merge(\n        {},\n        currentTheme,\n        {\n          baseMarkGroupName: graphicItemName,\n          // FIXME: hack\n          // 标签是对数据顺序有强要求的场景，因为顺序会影响标签躲避结果；而目前没有机制保证 vrender 图元顺序与数据顺序一致。\n          // 这里目前只能通过自定义方法来 hack\n          getBaseMarks: () => mark.elements.map(element => element.getGraphicItem())\n        },\n        addition ?? {}\n      );\n      result.data = data ?? currentTheme.data;\n      return result;\n    })\n    .filter(label => !isNil(label));\n\n  const result = merge({}, labelTheme, { size: groupSize });\n  result.dataLabels = dataLabels;\n  return result;\n};\n\nexport class Label extends Component implements ILabel {\n  static readonly componentType: string = ComponentEnum.label;\n  protected declare spec: LabelSpec;\n\n  constructor(view: IView, group?: IGroupMark) {\n    super(view, ComponentEnum.label, group);\n    this.spec.componentType = ComponentEnum.label;\n  }\n\n  protected parseAddition(spec: LabelSpec) {\n    super.parseAddition(spec);\n    this.labelStyle(spec.labelStyle);\n    this.size(spec.size);\n    this.target(spec.target);\n    return this;\n  }\n\n  labelStyle(style: MarkFunctionType<Partial<BaseLabelAttrs>>) {\n    return this.setFunctionSpec(style, 'labelStyle');\n  }\n\n  size(size: LabelSpec['size']) {\n    return this.setFunctionSpec(size, 'size');\n  }\n\n  target(mark: IMark | IMark[] | string | string[] | Nil): this {\n    if (this.spec.target) {\n      const prevMarks = array(this.spec.target).map(m => (isString(m) ? this.view.getMarkById(m) : m));\n      this.detach(prevMarks);\n    }\n    this.spec.target = mark;\n    if (mark) {\n      const nextMarks = array(mark).map(m => (isString(m) ? this.view.getMarkById(m) : m));\n      this.attach(nextMarks);\n    }\n    this.commit();\n    return this;\n  }\n\n  protected _updateComponentEncoders() {\n    const encoders = Object.assign({ update: {} }, this.spec.encode);\n    const componentEncoders: StateEncodeSpec = Object.keys(encoders).reduce((res, state) => {\n      const encoder = encoders[state];\n      if (encoder) {\n        res[state] = {\n          callback: (datum: any, element: IElement, parameters: any) => {\n            const marks = array(this.spec.target).map(m => (isString(m) ? this.view.getMarkById(m) : m));\n            const groupGraphicItem = this.group?.getGroupGraphicItem?.();\n            let size = invokeFunctionType(this.spec.size, parameters);\n            if (!size) {\n              size = groupGraphicItem\n                ? {\n                    width: groupGraphicItem.attribute.width ?? groupGraphicItem.AABBBounds.width(),\n                    height: groupGraphicItem.attribute.height ?? groupGraphicItem.AABBBounds.height()\n                  }\n                : { width: Infinity, height: Infinity };\n            }\n\n            const theme = this.spec.skipTheme ? null : this.view.getCurrentTheme();\n\n            return generateLabelAttributes(\n              marks,\n              size,\n              encoder as BaseSingleEncodeSpec,\n              this.spec.labelStyle,\n              parameters,\n              theme\n            );\n          }\n        };\n      }\n      return res;\n    }, {});\n    this._encoders = componentEncoders;\n  }\n}\n\nexport const registerLabel = () => {\n  Factory.registerGraphicComponent(\n    ComponentEnum.label,\n    (attrs: DataLabelAttrs) => new DataLabel(attrs) as unknown as IGraphic\n  );\n\n  Factory.registerComponent(ComponentEnum.label, Label);\n};\n"]}