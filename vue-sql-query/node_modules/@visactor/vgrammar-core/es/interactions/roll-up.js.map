{"version":3,"sources":["../src/interactions/roll-up.ts"],"names":[],"mappings":"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","file":"roll-up.js","sourcesContent":["import type { EventType, IView, InteractionEvent, RollUpOptions } from '../types';\nimport { DataFilterRank } from '../graph/enums';\nimport { isArray, isString } from '@visactor/vutils';\nimport { Filter } from './filter';\n\nexport class RollUp extends Filter {\n  static type: string = 'roll-up';\n  type: string = RollUp.type;\n\n  static defaultOptions: Omit<RollUpOptions, 'target'> = {\n    trigger: 'click',\n    triggerOff: 'empty'\n  };\n  options: RollUpOptions;\n\n  protected _isToggle: boolean = false;\n\n  constructor(view: IView, options?: RollUpOptions) {\n    super(view, options);\n    this.options = Object.assign({}, RollUp.defaultOptions, options);\n\n    this._marks = view.getMarksBySelector(this.options.source);\n    this._data = isString(this.options.target.data)\n      ? view.getDataById(this.options.target.data)\n      : this.options.target.data;\n  }\n\n  protected getEvents() {\n    if (!this._marks || this._marks.length === 0) {\n      return [];\n    }\n\n    if (!this._data) {\n      return [];\n    }\n\n    const transform = this.options.target.transform;\n\n    const getFilterValue = (event: InteractionEvent) => event?.element?.getDatum?.();\n    const dataTransform = (data: any[], filterValue: any) => {\n      return transform(data, filterValue);\n    };\n\n    this._filterData(this._data, null, DataFilterRank.rollUp, getFilterValue, undefined, dataTransform);\n\n    const events = [\n      {\n        type: this.options.trigger,\n        handler: this.handleStart\n      }\n    ];\n\n    const eventName =\n      this.options.triggerOff === 'empty'\n        ? this.options.trigger\n        : this.options.triggerOff.includes('view:')\n        ? this.options.triggerOff.replace('view:', '')\n        : this.options.triggerOff;\n\n    if (eventName !== this.options.trigger) {\n      events.push({\n        type: eventName as EventType,\n        handler: this.handleReset\n      });\n      this._isToggle = false;\n    } else {\n      this._isToggle = true;\n    }\n\n    return events;\n  }\n\n  protected handleStart = (event: InteractionEvent) => {\n    const element = event.element;\n    if (element && this._marks && this._marks.includes(element.mark)) {\n      const filterValue = event.element?.getDatum?.();\n\n      const isEqualFilterValue =\n        filterValue === this._filterData ||\n        (isArray(filterValue) &&\n          isArray(this._filterValue) &&\n          filterValue.length === this._filterValue.length &&\n          filterValue.every(datum => !this._filterValue.includes(datum)));\n\n      if (isEqualFilterValue) {\n        // reset filter value when toggle is enabled\n        if (this._isToggle) {\n          this._filterValue = null;\n          this.handleFilter(event);\n        }\n      } else {\n        this.handleFilter(event);\n      }\n    }\n  };\n\n  protected handleReset = (event: InteractionEvent) => {\n    if (this._filterValue) {\n      this._filterValue = null;\n      this.handleFilter(event);\n    }\n  };\n}\n"]}