{"version":3,"sources":["../src/interactions/view-zoom-mixin.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,KAAK,EAAE,KAAK,EAAE,MAAM,kBAAkB,CAAC;AAQhD,OAAO,EAAE,yBAAyB,EAAE,MAAM,cAAc,CAAC;AAEzD,MAAM,OAAO,aAAa;IAUd,gBAAgB,CAAC,CAAmB;QAC5C,MAAM,KAAK,GAAI,CAAS,CAAC,KAAK,CAAC;QAC/B,IAAI,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,EAAE;YAC1B,IAAI,CAAC,UAAU,GAAG,KAAK,CAAC;YACxB,OAAO,CAAC,CAAC;SACV;QACD,MAAM,SAAS,GAAG,KAAK,GAAG,IAAI,CAAC,UAAU,CAAC;QAE1C,IAAI,CAAC,UAAU,GAAG,KAAK,CAAC;QACxB,MAAM,MAAM,GAAI,CAAS,CAAC,MAAM,CAAC;QAEhC,CAAS,CAAC,SAAS,GAAG,SAAS,CAAC;QAChC,CAAS,CAAC,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC;QAC3B,CAAS,CAAC,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC;QAE5B,OAAO,CAAC,CAAC;IACX,CAAC;IAES,gBAAgB,CAAC,CAAmB;QAM5C,IAAI,CAAE,CAAS,CAAC,OAAO,EAAE;YACtB,CAAS,CAAC,SAAS,GAAG,IAAI,CAAC;YAC3B,CAAS,CAAC,KAAK,GAAG,IAAI,CAAC;YACvB,CAAS,CAAC,KAAK,GAAG,IAAI,CAAC;YACxB,OAAO,CAAC,CAAC;SACV;QAGD,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,MAAM,EAAE,CAAE,CAAS,CAAC,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,EAAE,EAAG,CAAS,CAAC,SAAS,CAAC,CAAC,CAAC;QAE3F,CAAS,CAAC,SAAS,GAAG,SAAS,CAAC;QAChC,CAAS,CAAC,KAAK,GAAG,CAAC,CAAC,OAAO,CAAC;QAC5B,CAAS,CAAC,KAAK,GAAG,CAAC,CAAC,OAAO,CAAC;QAC7B,OAAO,CAAC,CAAC;IACX,CAAC;IAED,eAAe,CAAC,CAAmB;QACjC,IAAI,CAAC,CAAC,EAAE;YACN,OAAO,CAAC,CAAC;SACV;QAED,IAAI,CAAC,CAAC,IAAI,KAAK,OAAO,EAAE;YACtB,OAAO,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC;SACjC;QAED,OAAO,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC;IAClC,CAAC;IAED,eAAe,CACb,cAAgC,CAAC,CAAC,EAAE,CAAC,CAAC,EACtC,KAAuB,EACvB,SAA8D,EAC9D,WAAgD;;QAEhD,MAAM,EAAE,SAAS,EAAE,GAAG,SAAS,CAAC;QAEhC,MAAM,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,CAAC,GAAG,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC;QAE7D,IAAI,UAAU,IAAI,CAAC,IAAI,SAAS,IAAI,CAAC,EAAE;YACrC,OAAO;SACR;QACD,IAAI,UAAU,IAAI,IAAI,IAAI,SAAS,IAAI,CAAC,EAAE;YACxC,OAAO;SACR;QACD,MAAM,KAAK,GAAG,CAAC,UAAU,GAAG,CAAC,SAAS,GAAG,CAAC,CAAC,GAAG,CAAC,MAAA,WAAW,CAAC,IAAI,mCAAI,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC;QAE3E,MAAM,KAAK,GAAG,KAAK,CAAC,WAAW,CAAC,CAAC,CAAC,GAAG,KAAK,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;QAClD,MAAM,GAAG,GAAG,KAAK,CAAC,WAAW,CAAC,CAAC,CAAC,GAAG,KAAK,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;QAEhD,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,KAAK,EAAE,GAAG,CAAC,EAAE,IAAI,CAAC,GAAG,CAAC,KAAK,EAAE,GAAG,CAAC,CAAqB,CAAC;IAC1E,CAAC;IAES,cAAc,CACtB,OAA4D,EAC5D,QAAoD,EACpD,WAAmC;QAEnC,MAAM,GAAG,GAAwB,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC;QACvD,IAAI,CAAC,QAAQ,EAAE;YACb,OAAO,GAAG,CAAC;SACZ;QAED,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE;YAClC,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,eAAe,EAAE,WAAW,EAAE,eAAe,EAAE,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC;YAErF,IAAI,eAAe,EAAE;gBACnB,GAAG,CAAC,GAAG,CAAC,GAAG,IAAI,CAAC,eAAe,CAAC,yBAAyB,CAAC,eAAe,CAAC,EAAE,IAAI,EAAE,OAAO,EAAE,WAAW,CAAC,CAAC;aACzG;iBAAM,IAAI,KAAK,EAAE;gBAChB,MAAM,UAAU,GAAG,KAAK,CAAC,QAAQ,EAAE,CAAC;gBACpC,MAAM,QAAQ,GAAG,IAAI,CAAC,eAAe,CAAC,WAAW,EAAE,UAAU,EAAE,OAAO,EAAE,WAAW,CAAC,CAAC;gBAErF,IAAI,QAAQ,EAAE;oBACZ,QAAQ,CAAC,GAAG,CAAC,CAAC,WAAW,GAAG,QAAQ,CAAC;oBAErC,IAAI,IAAI,EAAE;wBACR,QAAQ,CAAC,GAAG,CAAC,CAAC,WAAW,GAAG,QAAQ,CAAC;wBAErC,IAAI,CAAC,MAAM,EAAE,CAAC;qBACf;yBAAM;wBACL,KAAK,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;wBAC/B,KAAK,CAAC,MAAM,EAAE,CAAC;qBAChB;oBACD,GAAG,CAAC,UAAU,GAAG,IAAI,CAAC;oBACtB,GAAG,CAAC,GAAG,CAAC,GAAG,QAAQ,CAAC;iBACrB;aACF;iBAAM;gBACL,MAAM,QAAQ,GAAG,CAAC,eAAe,CAAC,CAAC,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;gBAC/E,MAAM,QAAQ,GAAG,IAAI,CAAC,eAAe,CAAC,QAAQ,EAAE,IAAI,EAAE,OAAO,EAAE,WAAW,CAAC,CAAC;gBAE5E,GAAG,CAAC,GAAG,CAAC,GAAG,QAAQ,IAAI,QAAQ,CAAC;aACjC;QACH,CAAC,CAAC,CAAC;QACH,OAAO,GAAG,CAAC;IACb,CAAC;IAED,eAAe,CACb,CAAmB,EACnB,QAAoD,EACpD,WAAmC;QAEnC,IAAI,KAAK,CAAE,CAAS,CAAC,SAAS,CAAC,EAAE;YAC/B,OAAO;SACR;QACD,CAAC,CAAC,eAAe,EAAE,CAAC;QACpB,CAAC,CAAC,cAAc,EAAE,CAAC;QAEnB,IAAI,WAAW,IAAI,WAAW,CAAC,QAAQ,EAAE;YACvC,OAAO,IAAI,CAAC,cAAc,CACxB,CAAmE,EACnE,QAAQ,EACR,WAAW,CACZ,CAAC;SACH;QAED,IAAI,KAAK,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE;YACxB,IAAI,CAAC,QAAQ,GAAG;gBACd,SAAS,EAAG,CAAS,CAAC,SAAS;gBAC/B,KAAK,EAAG,CAAS,CAAC,KAAK;gBACvB,KAAK,EAAG,CAAS,CAAC,KAAK;aACxB,CAAC;SACH;aAAM;YACL,IAAI,CAAC,QAAQ,CAAC,SAAS,IAAK,CAAS,CAAC,SAAS,CAAC;SACjD;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAED,aAAa,CACX,CAAmB,EACnB,QAAoD,EACpD,WAAmC;QAEnC,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC;QACvB,MAAM,GAAG,GACP,WAAW,IAAI,WAAW,CAAC,QAAQ,KAAK,KAAK,IAAI,IAAI,CAAC,QAAQ;YAC5D,CAAC,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,EAAE,QAAQ,EAAE,WAAW,CAAC;YAC3D,CAAC,CAAC,IAAI,CAAC;QAEX,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QAErB,OAAO,GAAG,CAAC;IACb,CAAC;IAED,eAAe,CACb,CAAmB,EACnB,QAAoD,EACpD,WAAmC;QAEnC,MAAM,GAAG,GAAwB,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC;QACvD,IAAI,CAAC,QAAQ,EAAE;YACb,OAAO,GAAG,CAAC;SACZ;QAED,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE;YAClC,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,eAAe,EAAE,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC;YACvD,MAAM,QAAQ,GAAG,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;YAExB,IAAI,eAAe,EAAE;gBACnB,GAAG,CAAC,GAAG,CAAC,GAAG,QAAQ,CAAC;aACrB;iBAAM,IAAI,KAAK,EAAE;gBAChB,QAAQ,CAAC,GAAG,CAAC,CAAC,WAAW,GAAG,IAAI,CAAC;gBAEjC,IAAI,IAAI,EAAE;oBACR,QAAQ,CAAC,GAAG,CAAC,CAAC,WAAW,GAAG,IAAI,CAAC;oBAEjC,IAAI,CAAC,MAAM,EAAE,CAAC;iBACf;qBAAM;oBACL,KAAK,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;oBAC/B,KAAK,CAAC,MAAM,EAAE,CAAC;iBAChB;gBACD,GAAG,CAAC,UAAU,GAAG,IAAI,CAAC;gBACtB,GAAG,CAAC,GAAG,CAAC,GAAG,QAAQ,CAAC;aACrB;iBAAM;gBACL,QAAQ,CAAC,GAAG,CAAC,CAAC,WAAW,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC,eAAe,CAAC;gBAC1D,GAAG,CAAC,GAAG,CAAC,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC,eAAe,CAAC;aAC1C;QACH,CAAC,CAAC,CAAC;QACH,OAAO,GAAG,CAAC;IACb,CAAC;CACF","file":"view-zoom-mixin.js","sourcesContent":["import { clamp, isNil } from '@visactor/vutils';\nimport type {\n  IViewZoomMixin,\n  InteractionEvent,\n  ViewNavigationRange,\n  ViewStateByDim,\n  ViewZoomSimpleOptions\n} from '../types';\nimport { getRangeOfLinkedComponent } from './view-utils';\n\nexport class ViewZoomMixin implements IViewZoomMixin {\n  protected declare _state: Partial<Record<'x' | 'y', ViewStateByDim>>;\n\n  protected _lastScale: number;\n  protected _zoomPos: {\n    zoomDelta: number;\n    zoomX: number;\n    zoomY: number;\n  };\n\n  protected _formatPinchZoom(e: InteractionEvent) {\n    const scale = (e as any).scale;\n    if (isNil(this._lastScale)) {\n      this._lastScale = scale;\n      return e;\n    }\n    const zoomDelta = scale / this._lastScale;\n\n    this._lastScale = scale;\n    const center = (e as any).center;\n\n    (e as any).zoomDelta = zoomDelta;\n    (e as any).zoomX = center.x;\n    (e as any).zoomY = center.y;\n\n    return e;\n  }\n\n  protected _formatWheelZoom(e: InteractionEvent) {\n    /**\n     * @see https://vega.github.io/vega/examples/zoomable-world-map/\n     * After testing, the ctrlKey field will only be true when the directions of the two fingers are inconsistent.\n     * Based on this, determine whether to trigger the scroll event.\n     */\n    if (!(e as any).ctrlKey) {\n      (e as any).zoomDelta = null;\n      (e as any).zoomX = null;\n      (e as any).zoomY = null;\n      return e;\n    }\n\n    // @see https://vega.github.io/vega/examples/zoomable-world-map/\n    const zoomDelta = Math.pow(1.0005, -(e as any).deltaY * Math.pow(16, (e as any).deltaMode));\n\n    (e as any).zoomDelta = zoomDelta;\n    (e as any).zoomX = e.canvasX;\n    (e as any).zoomY = e.canvasY;\n    return e;\n  }\n\n  formatZoomEvent(e: InteractionEvent) {\n    if (!e) {\n      return e;\n    }\n\n    if (e.type === 'pinch') {\n      return this._formatPinchZoom(e);\n    }\n\n    return this._formatWheelZoom(e);\n  }\n\n  updateZoomRange(\n    rangeFactor: [number, number] = [0, 1],\n    range: [number, number],\n    zoomEvent: { zoomDelta: number; zoomX: number; zoomY: number },\n    zoomOptions?: { rate?: number; focus?: boolean }\n  ) {\n    const { zoomDelta } = zoomEvent;\n\n    const rangeDelta = Math.abs(rangeFactor[1] - rangeFactor[0]);\n\n    if (rangeDelta >= 1 && zoomDelta >= 1) {\n      return;\n    }\n    if (rangeDelta <= 1e-3 && zoomDelta <= 1) {\n      return;\n    }\n    const value = (rangeDelta * (zoomDelta - 1) * (zoomOptions.rate ?? 1)) / 2;\n\n    const start = clamp(rangeFactor[0] - value, 0, 1);\n    const end = clamp(rangeFactor[1] + value, 0, 1);\n\n    return [Math.min(start, end), Math.max(start, end)] as [number, number];\n  }\n\n  protected _handleZooming(\n    zoomPos: { zoomDelta: number; zoomX: number; zoomY: number },\n    navState: Partial<Record<'x' | 'y', ViewStateByDim>>,\n    zoomOptions?: ViewZoomSimpleOptions\n  ): ViewNavigationRange {\n    const res: ViewNavigationRange = { needUpdate: false };\n    if (!navState) {\n      return res;\n    }\n\n    Object.keys(navState).forEach(dim => {\n      const { scale, data, linkedComponent, rangeFactor, getCurrentRange } = navState[dim];\n\n      if (linkedComponent) {\n        res[dim] = this.updateZoomRange(getRangeOfLinkedComponent(linkedComponent), null, zoomPos, zoomOptions);\n      } else if (scale) {\n        const innerScale = scale.getScale();\n        const newRange = this.updateZoomRange(rangeFactor, innerScale, zoomPos, zoomOptions);\n\n        if (newRange) {\n          navState[dim].rangeFactor = newRange;\n\n          if (data) {\n            navState[dim].filterValue = newRange;\n\n            data.commit();\n          } else {\n            scale.setRangeFactor(newRange);\n            scale.commit();\n          }\n          res.needUpdate = true;\n          res[dim] = newRange;\n        }\n      } else {\n        const oldRange = (getCurrentRange ? getCurrentRange() : rangeFactor) || [0, 1];\n        const newRange = this.updateZoomRange(oldRange, null, zoomPos, zoomOptions);\n\n        res[dim] = newRange || oldRange;\n      }\n    });\n    return res;\n  }\n\n  handleZoomStart(\n    e: InteractionEvent,\n    navState: Partial<Record<'x' | 'y', ViewStateByDim>>,\n    zoomOptions?: ViewZoomSimpleOptions\n  ): ViewNavigationRange {\n    if (isNil((e as any).zoomDelta)) {\n      return;\n    }\n    e.stopPropagation();\n    e.preventDefault();\n\n    if (zoomOptions && zoomOptions.realtime) {\n      return this._handleZooming(\n        e as unknown as { zoomDelta: number; zoomX: number; zoomY: number },\n        navState,\n        zoomOptions\n      );\n    }\n\n    if (isNil(this._zoomPos)) {\n      this._zoomPos = {\n        zoomDelta: (e as any).zoomDelta,\n        zoomX: (e as any).zoomX,\n        zoomY: (e as any).zoomY\n      };\n    } else {\n      this._zoomPos.zoomDelta *= (e as any).zoomDelta;\n    }\n\n    return null;\n  }\n\n  handleZoomEnd(\n    e: InteractionEvent,\n    navState: Partial<Record<'x' | 'y', ViewStateByDim>>,\n    zoomOptions?: ViewZoomSimpleOptions\n  ): ViewNavigationRange {\n    this._lastScale = null;\n    const res =\n      zoomOptions && zoomOptions.realtime === false && this._zoomPos\n        ? this._handleZooming(this._zoomPos, navState, zoomOptions)\n        : null;\n\n    this._zoomPos = null;\n\n    return res;\n  }\n\n  handleZoomReset(\n    e: InteractionEvent,\n    navState: Partial<Record<'x' | 'y', ViewStateByDim>>,\n    zoomOptions?: ViewZoomSimpleOptions\n  ): ViewNavigationRange {\n    const res: ViewNavigationRange = { needUpdate: false };\n    if (!navState) {\n      return res;\n    }\n\n    Object.keys(navState).forEach(dim => {\n      const { scale, data, linkedComponent } = navState[dim];\n      const newRange = [0, 1];\n\n      if (linkedComponent) {\n        res[dim] = newRange;\n      } else if (scale) {\n        navState[dim].rangeFactor = null;\n\n        if (data) {\n          navState[dim].filterValue = null;\n\n          data.commit();\n        } else {\n          scale.setRangeFactor(newRange);\n          scale.commit();\n        }\n        res.needUpdate = true;\n        res[dim] = newRange;\n      } else {\n        navState[dim].rangeFactor = navState[dim].initRangeFactor;\n        res[dim] = navState[dim].initRangeFactor;\n      }\n    });\n    return res;\n  }\n}\n"]}