{"version":3,"sources":["../src/view/view-event-mixin.ts"],"names":[],"mappings":"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","file":"view-event-mixin.js","sourcesContent":["import { isObject, isString, mixin } from '@visactor/vutils';\nimport type { BaseEventSpec, EventSpec } from '../types/event';\nimport type { IView, IViewEventConfig } from '../types/view';\nimport { generateFilterByMark, parseEventSelector, parseHandler } from '../parse/event';\nimport { parseReference } from '../parse/util';\nimport { EVENT_SOURCE_VIEW, EVENT_SOURCE_WINDOW, NO_TRAP } from './constants';\nimport { permit, prevent } from './events';\n// eslint-disable-next-line no-duplicate-imports\nimport { vglobal } from '@visactor/vrender-core';\nimport type { IElement } from '../types/element';\nimport getExtendedEvents from '../graph/util/events-extend';\nimport View from './View';\n\nclass ViewEventsMixin {\n  private _eventConfig: IViewEventConfig;\n  private _eventCache: Record<string, () => void>;\n  private _eventListeners: Array<{\n    type: string;\n    source: any;\n    handler: any;\n  }>;\n\n  event(eventSpec: EventSpec) {\n    if ('between' in eventSpec) {\n      const [starEvent, endEvent] = eventSpec.between;\n      // FIXME between需要生成唯一ID\n      const id = `${starEvent.type}-${eventSpec.type}-${endEvent.type}`;\n\n      let unbindEndEvent: any;\n\n      this.bindEvents(\n        Object.assign({}, starEvent, {\n          callback: () => {\n            if (!this._eventCache) {\n              this._eventCache = {};\n            }\n            // 中间的事件绑定\n            if (!this._eventCache[id]) {\n              const unbindEvent = this.bindEvents(eventSpec);\n              this._eventCache[id] = unbindEvent;\n            }\n            if (!unbindEndEvent) {\n              // 结束的事件绑定\n              unbindEndEvent = this.bindEvents(\n                Object.assign({}, endEvent, {\n                  callback: () => {\n                    if (this._eventCache[id]) {\n                      this._eventCache[id]();\n                      this._eventCache[id] = null;\n                    }\n                  }\n                })\n              );\n            }\n          }\n        })\n      );\n    } else if ('merge' in eventSpec) {\n      eventSpec.merge.forEach(entry => {\n        const singleEvent: Partial<BaseEventSpec> = Object.assign({}, eventSpec);\n\n        if (isString(entry)) {\n          singleEvent.type = entry;\n        } else if (isObject(entry)) {\n          Object.assign(singleEvent, entry);\n        }\n        singleEvent.debounce = 50;\n        this.bindEvents(singleEvent as BaseEventSpec);\n      });\n    } else {\n      this.bindEvents(eventSpec);\n    }\n  }\n\n  // --- Event ---\n\n  private bindEvents(eventSpec: BaseEventSpec) {\n    if (this._eventConfig.disable) {\n      return;\n    }\n    const { type: evtType, filter, callback, throttle, debounce, consume, target, dependency } = eventSpec;\n    const eventSelector = parseEventSelector(evtType);\n\n    if (!eventSelector) {\n      return;\n    }\n    const { source, type } = eventSelector;\n\n    const markFilter = generateFilterByMark(eventSelector);\n    const targetSignals =\n      Array.isArray(target) && target.length\n        ? target.map(entry => {\n            return {\n              signal: (this as unknown as IView).getSignalById(entry.target),\n              callback: entry.callback\n            };\n          })\n        : [\n            {\n              signal: isString(target) ? (this as unknown as IView).getSignalById(target) : null,\n              callback\n            }\n          ];\n    const validateSignals = targetSignals.filter(entry => entry.signal || entry.callback);\n    const refs = parseReference(dependency, this as unknown as IView);\n\n    const send = parseHandler(\n      (evt?: any) => {\n        const needPreventDefault =\n          (source === EVENT_SOURCE_VIEW && prevent(this._eventConfig, type)) ||\n          (consume && (evt.cancelable === undefined || evt.cancelable));\n\n        if (source === EVENT_SOURCE_WINDOW) {\n          evt = getExtendedEvents(this as unknown as IView, evt, type, EVENT_SOURCE_WINDOW);\n        }\n\n        let hasCommitted = false;\n\n        if ((!filter || filter(evt)) && (!markFilter || markFilter(evt.element)) && validateSignals.length) {\n          const params = refs.reduce((params, ref) => {\n            params[ref.id()] = ref.output();\n            return params;\n          }, {});\n          validateSignals.forEach(entry => {\n            if (entry.callback && entry.signal) {\n              const changed = entry.signal.set(entry.callback(evt, params));\n\n              if (changed) {\n                (this as unknown as IView).commit(entry.signal);\n                hasCommitted = true;\n              }\n            } else if (entry.callback) {\n              entry.callback(evt, params);\n            } else {\n              (this as unknown as IView).commit(entry.signal);\n              hasCommitted = true;\n            }\n          });\n        }\n\n        if (needPreventDefault) {\n          evt.preventDefault();\n        }\n\n        if (consume) {\n          evt.stopPropagation();\n        }\n\n        if (hasCommitted) {\n          (this as unknown as IView).run();\n        }\n      },\n      { throttle, debounce }\n    );\n\n    if (source === EVENT_SOURCE_VIEW) {\n      if (permit(this._eventConfig, EVENT_SOURCE_VIEW, type)) {\n        // send traps errors, so use {trap: false} option\n        (this as unknown as IView).addEventListener(type, send, NO_TRAP);\n\n        return () => {\n          (this as unknown as IView).removeEventListener(type, send);\n        };\n      }\n    } else if (source === EVENT_SOURCE_WINDOW) {\n      vglobal.addEventListener(type, send);\n      this._eventListeners.push({\n        type: type,\n        source: vglobal,\n        handler: send\n      });\n\n      return () => {\n        vglobal.removeEventListener(type, send);\n\n        const index = this._eventListeners.findIndex((entry: any) => {\n          return entry.type === type && entry.source === vglobal && entry.handler === send;\n        });\n\n        if (index >= 0) {\n          this._eventListeners.splice(index, 1);\n        }\n      };\n    }\n  }\n}\n\nexport const registerViewEventsAPI = () => {\n  mixin(View, ViewEventsMixin);\n};\n"]}