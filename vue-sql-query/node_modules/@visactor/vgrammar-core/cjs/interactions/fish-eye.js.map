{"version":3,"sources":["../src/interactions/fish-eye.ts"],"names":[],"mappings":"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","file":"fish-eye.js","sourcesContent":["import { isNil, isString, throttle } from '@visactor/vutils';\nimport type { FishEyeOptions, IMark, IScale, IView, InteractionEvent, ViewNavigationRange } from '../types';\nimport { BaseInteraction } from './base';\n\nexport class FishEye extends BaseInteraction<FishEyeOptions> {\n  static type: string = 'fish-eye';\n  type: string = FishEye.type;\n\n  static defaultOptions: FishEyeOptions = {\n    trigger: 'pointerenter',\n    updateTrigger: 'pointermove',\n    endTrigger: 'pointerleave',\n    distortionX: 2,\n    distortionY: 2,\n    throttle: 100\n  };\n\n  options: FishEyeOptions;\n  protected _inited?: boolean;\n  protected _state: Partial<\n    Record<'x' | 'y', { scale?: IScale; focus?: number; distortion?: number; radius?: number; radiusRatio?: number }>\n  >;\n  protected _isActive?: boolean;\n  protected _marks?: IMark[];\n\n  protected handleUpdate: (e: InteractionEvent) => void;\n\n  constructor(view: IView, options?: FishEyeOptions) {\n    super(view, options);\n    this.options = Object.assign({}, FishEye.defaultOptions, options);\n    this._marks = view.getMarksBySelector(this.options.selector);\n\n    this.handleUpdate = throttle(this.handleUpdateInner, this.options.throttle);\n  }\n\n  protected getEvents() {\n    return [\n      { type: this.options.trigger, handler: this.handleStart },\n      { type: this.options.updateTrigger, handler: this.handleUpdate },\n      { type: this.options.endTrigger, handler: this.handleEnd },\n      { type: this.options.triggerOff, handler: this.handleReset }\n    ];\n  }\n\n  protected _initStateByDim(\n    dim: 'x' | 'y',\n    distortion: number,\n    scale?: string | IScale,\n    radius?: number,\n    radiusRatio?: number\n  ) {\n    const scaleGrammar = !isNil(scale) ? (isString(scale) ? this.view.getScaleById(scale) : scale) : null;\n\n    this._state[dim] = { scale: scaleGrammar, distortion, radius, radiusRatio };\n  }\n\n  protected _initGrammars() {\n    const { enableX, enableY, scaleX, scaleY, distortionX, distortionY, radiusRatioX, radiusRatioY, radiusX, radiusY } =\n      this.options;\n\n    this._state = {};\n\n    if (enableX !== false) {\n      this._initStateByDim('x', distortionX, scaleX, radiusX, radiusRatioX);\n    }\n\n    if (enableY !== false) {\n      this._initStateByDim('y', distortionY, scaleY, radiusY, radiusRatioY);\n    }\n\n    this._inited = true;\n  }\n\n  updateView(focus?: { x: number; y: number }, e?: InteractionEvent) {\n    let needUpdate = false;\n\n    if (focus) {\n      Object.keys(this._state).forEach(dim => {\n        const dimState = this._state[dim];\n\n        if (dimState.scale && dimState.focus !== focus[dim]) {\n          needUpdate = true;\n          // 坐标转换问题\n          dimState.focus = focus[dim];\n          dimState.scale.setFishEye({\n            distortion: dimState.distortion,\n            radius: dimState.radius,\n            radiusRatio: dimState.radiusRatio,\n            focus: focus[dim]\n          });\n          dimState.scale.commit();\n        }\n      });\n    } else {\n      Object.keys(this._state).forEach(dim => {\n        const dimState = this._state[dim];\n\n        if (dimState.scale && !isNil(dimState.focus)) {\n          needUpdate = true;\n          // 坐标转换问题\n          dimState.focus = null;\n          dimState.scale.setFishEye(null);\n          dimState.scale.commit();\n        }\n      });\n    }\n\n    if (needUpdate) {\n      this.view.run();\n    }\n  }\n\n  shouldHandle(e: InteractionEvent) {\n    if (this._marks) {\n      return e.element && this._marks && this._marks.includes(e.element.mark);\n    }\n    return (e.target as any) === this.view?.renderer?.stage?.();\n  }\n\n  shouldUpdate(e: InteractionEvent) {\n    if (this._marks) {\n      return e.element && this._marks && this._marks.includes(e.element.mark);\n    }\n    const viewBox = this.view.getViewBox();\n    return e.canvasX >= viewBox.x1 && e.canvasX <= viewBox.x2 && e.canvasY >= viewBox.y1 && e.canvasY <= viewBox.y2;\n  }\n\n  handleStart = (e: InteractionEvent) => {\n    if (!e || !(this.options.shouldStart ? this.options.shouldStart(e) : this.shouldHandle(e))) {\n      return;\n    }\n\n    if (!this._inited) {\n      this._initGrammars();\n    }\n    if (!this._isActive) {\n      this._isActive = true;\n      this.updateView({ x: e.canvasX, y: e.canvasY }, e);\n    }\n  };\n\n  handleUpdateInner = (e: InteractionEvent) => {\n    if (!e || !(this.options.shouldUpdate ? this.options.shouldUpdate(e) : this.shouldUpdate(e))) {\n      return;\n    }\n\n    this._isActive && this.updateView({ x: e.canvasX, y: e.canvasY }, e);\n  };\n\n  handleEnd = (e: InteractionEvent) => {\n    if (!e || !(this.options.shouldEnd ? this.options.shouldEnd(e) : this.shouldHandle(e))) {\n      return;\n    }\n\n    if (!this.options.triggerOff && this._isActive) {\n      this._isActive = false;\n      this.updateView(null, e);\n    }\n  };\n\n  handleReset = (e: InteractionEvent) => {\n    if (!e || !(this.options.shouldReset ? this.options.shouldReset(e) : this.shouldHandle(e))) {\n      return;\n    }\n\n    if (this._isActive) {\n      this.updateView(null, e);\n      this._isActive = false;\n    }\n  };\n\n  unbind() {\n    super.unbind();\n\n    if (this._state) {\n      Object.keys(this._state).forEach(dim => {\n        const { scale } = this._state[dim as 'x' | 'y'];\n\n        if (scale) {\n          scale.setRangeFactor(null);\n          scale.commit();\n        }\n      });\n    }\n\n    this._state = null;\n  }\n}\n"]}