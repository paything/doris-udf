{"version":3,"sources":["../src/event/listener/touch.ts"],"names":[],"mappings":"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","file":"touch.js","sourcesContent":["import { vglobal } from './../../vrender';\nimport type { FederatedPointerEvent } from './../../vrender';\nimport { handleWhell, isHorizontalScrollable, isVerticalScrollable } from '../scroll';\nimport type { EventManager } from '../event';\nimport { IconFuncTypeEnum } from '../../ts-types';\n\nexport function bindTouchListener(eventManager: EventManager) {\n  const table = eventManager.table;\n  const stateManager = table.stateManager;\n  const scenegraph = table.scenegraph;\n  if (vglobal.envContribution.supportsTouchEvents === false) {\n    return;\n  }\n  // 阻止右键事件\n  vglobal.addEventListener(\n    'contextmenu',\n    e => {\n      e.stopPropagation();\n      e.preventDefault();\n    },\n    // 捕获阶段就阻止\n    { capture: true }\n  );\n\n  // deal width touch scrolling in mobile devices\n  eventManager.touchMovePoints = [];\n  table.scenegraph.tableGroup.addEventListener('touchstart', (e: FederatedPointerEvent) => {\n    if (e.target.isChildOf(scenegraph.component.vScrollBar) || e.target.isChildOf(scenegraph.component.vScrollBar)) {\n      return;\n    }\n    eventManager.isTouchdown = true;\n    const touchEvent = e.nativeEvent as TouchEvent;\n    eventManager.touchMovePoints.push({\n      x: table.rotateDegree ? (touchEvent.changedTouches?.[0] as any)?._canvasX ?? e.canvas?.x : e.page.x,\n      y: table.rotateDegree ? (touchEvent.changedTouches?.[0] as any)?._canvasY ?? e.canvas?.y : e.page.y,\n      timestamp: Date.now()\n    });\n  });\n\n  const globalTouchMoveCallback = (e: TouchEvent) => {\n    if (eventManager.isLongTouch) {\n      e.preventDefault();\n    }\n    if (!eventManager.isTouchdown || !isTouchEvent(e)) {\n      return;\n    }\n    eventManager.isTouchMove = true;\n    if ((eventManager.downIcon?.attribute as any)?.funcType === IconFuncTypeEnum.dragReorder) {\n      // console.log()\n      e.preventDefault();\n    } else {\n      // collect four last touch pisitions\n      if (eventManager.touchMovePoints.length > 4) {\n        eventManager.touchMovePoints.shift();\n      }\n      eventManager.touchMovePoints.push({\n        x: table.rotateDegree ? (e.changedTouches[0] as any)._canvasX : e.changedTouches[0].pageX,\n        y: table.rotateDegree ? (e.changedTouches[0] as any)._canvasY : e.changedTouches[0].pageY,\n        timestamp: Date.now()\n      });\n      if (eventManager._enableTableScroll) {\n        const deltaX =\n          -eventManager.touchMovePoints[eventManager.touchMovePoints.length - 1].x +\n          eventManager.touchMovePoints[eventManager.touchMovePoints.length - 2].x;\n        const deltaY =\n          -eventManager.touchMovePoints[eventManager.touchMovePoints.length - 1].y +\n          eventManager.touchMovePoints[eventManager.touchMovePoints.length - 2].y;\n        handleWhell({ deltaX, deltaY } as any, stateManager);\n\n        if (\n          e.cancelable &&\n          (table.internalProps.overscrollBehavior === 'none' ||\n            (Math.abs(deltaY) >= Math.abs(deltaX) && deltaY !== 0 && isVerticalScrollable(deltaY, stateManager)) ||\n            (Math.abs(deltaY) <= Math.abs(deltaX) && deltaX !== 0 && isHorizontalScrollable(deltaX, stateManager)))\n        ) {\n          e.preventDefault();\n        }\n      }\n    }\n  };\n  vglobal.addEventListener('touchmove', globalTouchMoveCallback, { passive: false });\n  eventManager.globalEventListeners.push({\n    name: 'touchmove',\n    env: 'vglobal',\n    callback: globalTouchMoveCallback\n  });\n\n  const globalTouchEndCallback = (e: TouchEvent) => {\n    eventManager.touchEnd = true;\n    eventManager.isLongTouch = false;\n    if (!eventManager.isTouchdown || !isTouchEvent(e)) {\n      return;\n    }\n    if ((eventManager.downIcon?.attribute as any)?.funcType === IconFuncTypeEnum.dragReorder) {\n      // console.log()\n      e.preventDefault();\n    } else {\n      if (eventManager.touchMovePoints?.length) {\n        if (eventManager.touchMovePoints.length > 4) {\n          eventManager.touchMovePoints.shift();\n        }\n        eventManager.touchMovePoints.push({\n          x: table.rotateDegree ? (e.changedTouches[0] as any)._canvasX : e.changedTouches[0].pageX,\n          y: table.rotateDegree ? (e.changedTouches[0] as any)._canvasY : e.changedTouches[0].pageY,\n          timestamp: Date.now()\n        });\n        // compute inertia parameter\n\n        if (eventManager._enableTableScroll) {\n          const firstPoint = eventManager.touchMovePoints[0];\n          const lastPoint = eventManager.touchMovePoints[eventManager.touchMovePoints?.length - 1];\n          const vX = (lastPoint.x - firstPoint.x) / (lastPoint.timestamp - firstPoint.timestamp);\n          const vY = (lastPoint.y - firstPoint.y) / (lastPoint.timestamp - firstPoint.timestamp);\n          //开始惯性滚动\n          eventManager.inertiaScroll.startInertia(vX, vY, 0.95);\n          table.eventManager.inertiaScroll.setScrollHandle((dx: number, dy: number) => {\n            handleWhell({ deltaX: -dx, deltaY: -dy } as any, table.stateManager);\n          });\n        }\n      }\n    }\n    eventManager.isTouchdown = false;\n    eventManager.isTouchMove = false;\n    eventManager.isDraging = false;\n    eventManager.touchMovePoints = [];\n  };\n  vglobal.addEventListener('touchend', globalTouchEndCallback);\n  eventManager.globalEventListeners.push({\n    name: 'touchend',\n    env: 'vglobal',\n    callback: globalTouchEndCallback\n  });\n\n  const globalTouchCancelCallback = (e: TouchEvent) => {\n    eventManager.touchEnd = true;\n    eventManager.isLongTouch = false;\n\n    if (!eventManager.isTouchdown) {\n      return;\n    }\n    eventManager.isTouchdown = false;\n    eventManager.isTouchMove = false;\n    eventManager.touchMovePoints = [];\n    eventManager.isDraging = false;\n  };\n  vglobal.addEventListener('touchcancel', globalTouchCancelCallback);\n  eventManager.globalEventListeners.push({\n    name: 'touchcancel',\n    env: 'vglobal',\n    callback: globalTouchCancelCallback\n  });\n}\n\nfunction isTouchEvent(e: TouchEvent | MouseEvent): e is TouchEvent {\n  return !!(e as TouchEvent).changedTouches;\n}\n"]}