{"version":3,"sources":["../src/scenegraph/graphic/icon.ts"],"names":[],"mappings":"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","file":"icon.js","sourcesContent":["import type { IImageGraphicAttribute, ISetAttributeContext, ITextGraphicAttribute } from './../../vrender';\nimport { Image, ResourceLoader, Text } from './../../vrender';\nimport type { IIconBase } from '../../ts-types';\nimport type { ParsedFrame } from 'gifuct-js';\nimport { decompressFrames, parseGIF } from 'gifuct-js';\n\nexport interface IIconGraphicAttribute extends IImageGraphicAttribute {\n  backgroundWidth?: number;\n  backgroundHeight?: number;\n  backgroundColor?: string;\n  visibleTime?: string;\n  funcType?: string;\n  hoverImage?: string | HTMLImageElement | HTMLCanvasElement;\n  originImage?: string | HTMLImageElement | HTMLCanvasElement;\n  // margin?: [number, number, number, number];\n  marginLeft?: number;\n  marginRight?: number;\n  shape?: 'circle' | 'square';\n  interactive?: boolean;\n}\n\nexport class Icon extends Image {\n  declare attribute: IIconGraphicAttribute;\n  role?: string;\n  tooltip?: IIconBase['tooltip'];\n  frameImageData?: ImageData;\n  tempCanvas?: HTMLCanvasElement;\n  tempCtx?: CanvasRenderingContext2D;\n  gifCanvas?: HTMLCanvasElement;\n  gifCtx?: CanvasRenderingContext2D;\n  loadedFrames?: ParsedFrame[];\n  frameIndex?: number;\n  playing?: boolean;\n  lastTime?: number;\n\n  // eslint-disable-next-line no-useless-constructor\n  constructor(params: IIconGraphicAttribute) {\n    super(params);\n\n    if (this.attribute.visibleTime === 'mouseenter_cell' || this.attribute.visibleTime === 'click_cell') {\n      this.attribute.opacity = 0;\n    }\n\n    if (this.attribute.hoverImage) {\n      this.attribute.originImage = this.attribute.image;\n    }\n\n    if ((this.attribute as any).isGif && (this.attribute as any).gif) {\n      this.loadGif();\n    }\n\n    // if (this.attribute.margin) {\n    //   this.attribute.boundsPadding = this.attribute.margin;\n    //   this.attribute.dx = this.attribute.margin[3] ?? 0;\n    // }\n  }\n\n  loadGif() {\n    this.playing = false;\n    ResourceLoader.GetFile((this.attribute as any).gif + '?role=gif' + `&radom=${Math.random()}`, 'arrayBuffer') // ?role=gif: hack for ResourceLoader cache\n      .then((res: ArrayBuffer) => {\n        const gif = parseGIF(res);\n        const frames = decompressFrames(gif, true);\n        this.renderGIF(frames);\n\n        // hack for image resource\n        (this as any).resources.set((this.attribute as any).image, {\n          state: 'success',\n          data: this.gifCanvas\n        });\n      })\n      .catch((e: any) => {\n        console.error('Gif load error: ', e);\n      });\n  }\n\n  get backgroundWidth(): number {\n    return this.attribute.backgroundWidth ?? this.attribute.width ?? 0;\n  }\n\n  get backgroundHeight(): number {\n    return this.attribute.backgroundHeight ?? this.attribute.height ?? 0;\n  }\n\n  // protected tryUpdateAABBBounds() {\n  //   super.tryUpdateAABBBounds();\n  //   // 扩大范围\n  //   const { width, height } = this.attribute;\n  //   const { backgroundWidth = width, backgroundHeight = height } = this.attribute;\n  //   const expandX = (backgroundWidth - width) / 2;\n  //   const expandY = (backgroundHeight - height) / 2;\n  //   this._AABBBounds.expand([expandY, expandX, expandY, expandX]);\n\n  //   return this._AABBBounds;\n  // }\n\n  renderGIF(frames: ParsedFrame[]) {\n    this.loadedFrames = frames;\n    this.frameIndex = 0;\n\n    if (!this.tempCanvas) {\n      this.tempCanvas = document.createElement('canvas');\n      this.tempCtx = this.tempCanvas.getContext('2d');\n    }\n\n    if (!this.gifCanvas) {\n      this.gifCanvas = document.createElement('canvas');\n      this.gifCtx = this.gifCanvas.getContext('2d');\n    }\n\n    this.gifCanvas.width = frames[0].dims.width;\n    this.gifCanvas.height = frames[0].dims.height;\n\n    this.playing = true;\n    this.lastTime = new Date().getTime();\n    this.animate().to({}, 1000, 'linear').loop(Infinity);\n  }\n\n  renderFrame(context: CanvasRenderingContext2D, x: number, y: number) {\n    // get the frame\n    const frame = this.loadedFrames[this.frameIndex || 0];\n\n    if (frame.disposalType === 2) {\n      this.gifCtx.clearRect(0, 0, this.gifCanvas.width, this.gifCanvas.height);\n    }\n\n    // draw the patch\n    this.drawPatch(frame);\n\n    // perform manipulation\n    this.manipulate(context, x, y);\n\n    // update the frame index\n    // this.frameIndex++;\n    const diff = new Date().getTime() - this.lastTime;\n    if (frame.delay < diff) {\n      // return;\n      this.frameIndex++;\n      this.lastTime = new Date().getTime();\n    }\n    if (this.frameIndex >= this.loadedFrames.length) {\n      this.frameIndex = 0;\n    }\n  }\n\n  drawPatch(frame: ParsedFrame) {\n    const dims = frame.dims;\n\n    if (\n      !this.frameImageData ||\n      dims.width !== this.frameImageData.width ||\n      dims.height !== this.frameImageData.height\n    ) {\n      this.tempCanvas.width = dims.width;\n      this.tempCanvas.height = dims.height;\n      this.frameImageData = this.tempCtx.createImageData(dims.width, dims.height);\n    }\n\n    // set the patch data as an override\n    this.frameImageData.data.set(frame.patch);\n\n    // draw the patch back over the canvas\n    this.tempCtx.putImageData(this.frameImageData, 0, 0);\n\n    // gifCtx.drawImage(tempCanvas, dims.left, dims.top)\n    // this.attribute.image = this.tempCanvas;\n\n    this.gifCtx.drawImage(this.tempCanvas, dims.left, dims.top);\n  }\n\n  manipulate(context: CanvasRenderingContext2D, x: number, y: number) {\n    context.drawImage(\n      this.gifCanvas,\n      0,\n      0,\n      this.gifCanvas.width,\n      this.gifCanvas.height,\n      x,\n      y,\n      this.attribute.width,\n      this.attribute.height\n    );\n  }\n\n  setAttribute(key: string, value: any, forceUpdateTag?: boolean, context?: ISetAttributeContext): void {\n    super.setAttribute(key, value, forceUpdateTag, context);\n    if (key === 'gif') {\n      this.loadGif();\n    }\n  }\n\n  setAttributes(\n    params: Partial<IIconGraphicAttribute>,\n    forceUpdateTag?: boolean,\n    context?: ISetAttributeContext\n  ): void {\n    super.setAttributes(params, forceUpdateTag, context);\n    if ((params as any).gif) {\n      this.loadGif();\n    }\n  }\n}\n\nexport class TextIcon extends Text {\n  declare attribute: IIconGraphicAttribute;\n  role?: string;\n  tooltip?: IIconBase['tooltip'];\n\n  constructor(params: ITextGraphicAttribute) {\n    // default text icon style\n    params.fill = params.fill ?? '#00F';\n    params.fontSize = params.fontSize ?? 12;\n    params.underline = params.underline ?? 1;\n    params.textBaseline = params.textBaseline ?? 'top';\n    params.cursor = params.cursor ?? 'pointer';\n    super(params);\n  }\n}\n"]}