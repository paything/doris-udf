{"version":3,"sources":["../src/scenegraph/graphic/contributions/chart-render-helper.ts"],"names":[],"mappings":"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","file":"chart-render-helper.js","sourcesContent":["import { container, VWindow, type IStage, type IWindow } from './../../../vrender';\nimport type { Chart } from '../chart';\nimport type { IAABBBounds } from '@visactor/vutils';\nimport { Bounds, isValid } from '@visactor/vutils';\nimport type { BaseTableAPI } from '../../../ts-types/base-table';\nexport const cancelRenderChartQueue = false;\nexport let chartRenderKeys: string[] = [];\nexport let chartRenderQueueList: Chart[] = [];\ninterface chartRenderQueueItem {\n  chart: Chart;\n}\n//每次消费的图表数量\nlet batchRenderChartCount = 5;\nlet isHandlingChartQueue = false;\nlet requestAnimationFrameId: number;\nexport function setBatchRenderChartCount(count: number) {\n  if (isValid(count)) {\n    batchRenderChartCount = count;\n  }\n}\nexport function clearChartRenderQueue() {\n  chartRenderKeys = [];\n  chartRenderQueueList = [];\n  isHandlingChartQueue = false;\n  cancelAnimationFrame(requestAnimationFrameId);\n}\nexport function IsHandlingChartQueue() {\n  return isHandlingChartQueue;\n}\nexport function renderChart(chart: Chart) {\n  const { axes, dataId, data, spec, ClassType, canvas, mode, modeParams, dpr } = chart.attribute;\n  let { chartInstance } = chart;\n  if (!chartInstance) {\n    chartInstance = new ClassType(spec, {\n      renderCanvas: canvas,\n      mode: mode === 'node' ? 'node' : 'desktop-browser',\n      modeParams: modeParams,\n      canvasControled: false,\n      viewBox: { x1: 0, x2: 0, y1: 0, y2: 0 },\n      dpr: dpr,\n      interactive: false,\n      animation: false,\n      autoFit: false\n    });\n    chartInstance.renderSync();\n    chart.chartInstance = chartInstance;\n  }\n  const viewBox = chart.getViewBox();\n\n  // avoid canvas size 0\n  if (viewBox.x2 <= viewBox.x1) {\n    viewBox.x2 = viewBox.x1 + 1;\n  }\n  if (viewBox.y2 <= viewBox.y1) {\n    viewBox.y2 = viewBox.y1 + 1;\n  }\n\n  // use vrender trasnform, viewbox starts from 0,0\n  chartInstance.updateViewBox(\n    // {\n    //   x1: viewBox.x1 - (chart.getRootNode() as any).table.scrollLeft,\n    //   x2: viewBox.x2 - (chart.getRootNode() as any).table.scrollLeft,\n    //   y1: viewBox.y1 - (chart.getRootNode() as any).table.scrollTop,\n    //   y2: viewBox.y2 - (chart.getRootNode() as any).table.scrollTop\n    // },\n    {\n      x1: 0,\n      x2: viewBox.x2 - viewBox.x1,\n      y1: 0,\n      y2: viewBox.y2 - viewBox.y1\n    },\n    false,\n    false\n  );\n\n  const chartStage = chartInstance.getStage();\n  const matrix = chart.globalTransMatrix.clone();\n  const stageMatrix = chart.stage.window.getViewBoxTransform();\n  matrix.multiply(stageMatrix.a, stageMatrix.b, stageMatrix.c, stageMatrix.d, stageMatrix.e, stageMatrix.f);\n  chartStage.window.setViewBoxTransform &&\n    chartStage.window.setViewBoxTransform(matrix.a, matrix.b, matrix.c, matrix.d, matrix.e, matrix.f);\n  // to be fixed: update state everytimes render, need be fix by vchart\n  //  测试的没发现问题  这里应该能去掉吧 留着每次都要调用一次\n  // const table = (chart.getRootNode() as any).table as BaseTableAPI;\n  // (table.internalProps.layoutMap as any)?.updateDataStateToActiveChartInstance?.(chartInstance);\n\n  const { table } = chart.getRootNode() as any;\n\n  let updateSpec = false;\n  if (table.options.specFormat) {\n    const formatResult = table.options.specFormat(chart.attribute.spec, chartInstance, chart);\n    if (formatResult.needFormatSpec && formatResult.spec) {\n      const spec = formatResult.spec;\n      chartInstance.updateSpecSync(spec);\n      updateSpec = formatResult.updateSpec ?? true;\n    }\n  }\n\n  if (!updateSpec) {\n    axes?.forEach((axis: any, index: number) => {\n      if (axis.type === 'band') {\n        // const chartAxis = chartInstance._chart._components[index];\n        // chartAxis._spec.domain = axis.domain.slice(0);\n        // chartAxis.updateScaleDomain();\n        chartInstance.updateModelSpec({ type: 'axes', index }, { domain: axis.domain.slice(0) }, true);\n      } else {\n        // const chartAxis = chartInstance._chart._components[index];\n        // chartAxis._domain = {\n        //   min: axis.range?.min ?? 0,\n        //   max: axis.range?.max ?? 0\n        // };\n        chartInstance.updateModelSpecSync(\n          { type: 'axes', index },\n          {\n            min: axis.range?.min ?? 0,\n            max: axis.range?.max ?? 0,\n            tick: {\n              tickMode: axis.tick?.tickMode\n            }\n          },\n          true\n        );\n      }\n    });\n\n    // to be fixed: update state everytimes render, need be fix by vchart\n    (table.internalProps.layoutMap as any)?.updateDataStateToActiveChartInstance?.(chartInstance);\n\n    if (typeof dataId === 'string') {\n      chartInstance.updateDataSync(dataId, data ?? []);\n    } else {\n      const dataBatch = [];\n      for (const dataIdStr in dataId) {\n        const dataIdAndField = dataId[dataIdStr];\n        const series = spec.series.find((item: any) => item?.data?.id === dataIdStr);\n        dataBatch.push({\n          id: dataIdStr,\n          values: dataIdAndField\n            ? data?.filter((item: any) => {\n                return item.hasOwnProperty(dataIdAndField);\n              }) ?? []\n            : data ?? [],\n          fields: series?.data?.fields\n        });\n        // 判断是否有updateFullDataSync 木有的话 还是循环调用updateDataSync\n        if (!chartInstance.updateFullDataSync) {\n          chartInstance.updateDataSync(\n            dataIdStr,\n            dataIdAndField\n              ? data?.filter((item: any) => {\n                  return item.hasOwnProperty(dataIdAndField);\n                }) ?? []\n              : data ?? []\n          );\n        }\n      }\n      chartInstance.updateFullDataSync?.(dataBatch);\n    }\n  }\n\n  table.fireListeners('before_cache_chart_image', { chartInstance });\n  const sg = chartInstance.getStage();\n  cacheStageCanvas(sg, chart);\n  // chart.cacheCanvas = sg.toCanvas();\n\n  // debugger;\n  // chart.cacheCanvas[] = sg.toCanvas(fullImage, viewBox);\n  // chart.cacheCanvas = sg.toCanvas(false, {\n  //   x1: 0,\n  //   y1: 0,\n  //   x2: 500,\n  //   y2: 300,\n  //   width: () => 500,\n  //   height: () => 300\n  // });\n  // 截图空白问题 因为开启了动画 首屏截图是无数据的TODO\n}\n\nexport function startRenderChartQueue(table: any) {\n  isHandlingChartQueue = true;\n\n  // 检查是否还有未渲染的图表\n  if (chartRenderQueueList.length > 0) {\n    // 使用 requestAnimationFrame 或 setTimeout 来调度下一批图表的渲染\n    // requestAnimationFrame(() => renderChartQueue(table));\n    requestAnimationFrameId = requestAnimationFrame(() => {\n      // 从集合中获取要渲染的图表上下文\n      const chartsToRender = chartRenderQueueList.splice(0, batchRenderChartCount);\n      chartRenderKeys.splice(0, batchRenderChartCount);\n      // 渲染图表\n      chartsToRender.forEach(chart => {\n        // 在正确的位置渲染图表\n        renderChart(chart);\n        chart.addUpdateBoundTag();\n      });\n      table.render();\n      startRenderChartQueue(table);\n    });\n    // setTimeout(() => {\n    //   // debugger;\n    //   renderChartQueue(table);\n    // }, 0);\n  } else {\n    isHandlingChartQueue = false;\n  }\n}\n\nconst cacheCanvasSizeLimit = 2000;\nexport function cacheStageCanvas(stage: IStage, chart: Chart) {\n  const { viewWidth, viewHeight } = stage;\n  if (viewWidth < cacheCanvasSizeLimit && viewHeight < cacheCanvasSizeLimit) {\n    chart.cacheCanvas = toCanvas(stage);\n    if (!chart.isShareChartSpec) {\n      // 不能整列共享chart的情况 生成完图片后即将chartInstance清除\n      chart.chartInstance?.release();\n      chart.chartInstance = null;\n      chart.setAttribute('chartInstance', null);\n    }\n    return;\n  }\n\n  const rows = Math.ceil(viewHeight / cacheCanvasSizeLimit);\n  const columns = Math.ceil(viewWidth / cacheCanvasSizeLimit);\n\n  const cacheCanvas = [];\n  for (let row = 0; row < rows; row++) {\n    for (let col = 0; col < columns; col++) {\n      const startX = col * cacheCanvasSizeLimit;\n      const startY = row * cacheCanvasSizeLimit;\n      const endX = startX + cacheCanvasSizeLimit > viewWidth ? viewWidth : startX + cacheCanvasSizeLimit;\n      const endY = startY + cacheCanvasSizeLimit > viewHeight ? viewHeight : startY + cacheCanvasSizeLimit;\n      const width = endX - startX;\n      const height = endY - startY;\n      const bounds = new Bounds();\n      bounds.setValue(startX, startY, endX, endY);\n\n      const canvas = toCanvas(stage, false, bounds);\n      cacheCanvas.push({\n        canvas,\n        x: startX,\n        y: startY,\n        width,\n        height\n      });\n    }\n  }\n\n  chart.cacheCanvas = cacheCanvas;\n}\n\nfunction toCanvas(stage: IStage, fullImage: boolean = true, viewBox?: IAABBBounds): HTMLCanvasElement | null {\n  if ((stage as any).releaseStatus === 'released') {\n    return null;\n  }\n  const matrix = stage.window.getViewBoxTransform();\n  const window = renderToNewWindow(stage, fullImage, viewBox);\n  window.setViewBoxTransform(matrix.a, matrix.b, matrix.c, matrix.d, 0, 0);\n  (stage as any).renderTo(window);\n  const c = window.getNativeHandler();\n  if (c.nativeCanvas) {\n    return c.nativeCanvas;\n  }\n  return null;\n}\n\nfunction renderToNewWindow(stage: IStage, fullImage: boolean = true, viewBox?: IAABBBounds): IWindow {\n  const matrix = stage.window.getViewBoxTransform();\n  const window = container.get<IWindow>(VWindow);\n  const x1 = viewBox ? -viewBox.x1 : 0;\n  const y1 = viewBox ? -viewBox.y1 : 0;\n  const x2 = viewBox ? viewBox.x2 : stage.viewWidth;\n  const y2 = viewBox ? viewBox.y2 : stage.viewHeight;\n  const width = viewBox ? viewBox.width() : stage.viewWidth;\n  const height = viewBox ? viewBox.height() : stage.viewHeight;\n  if (fullImage) {\n    window.create({\n      viewBox: { x1, y1, x2, y2 },\n      width: width * matrix.a,\n      height: height * matrix.d,\n      dpr: stage.window.dpr,\n      canvasControled: true,\n      offscreen: true,\n      title: ''\n    });\n  } else {\n    window.create({\n      viewBox: { x1, y1, x2, y2 },\n      width: width * matrix.a,\n      height: height * matrix.d,\n      dpr: stage.window.dpr,\n      canvasControled: true,\n      offscreen: true,\n      title: ''\n    });\n  }\n\n  (stage as any).renderTo(window);\n  return window;\n}\n"]}