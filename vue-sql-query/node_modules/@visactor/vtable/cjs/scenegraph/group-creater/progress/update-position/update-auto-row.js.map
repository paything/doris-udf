{"version":3,"sources":["../src/scenegraph/group-creater/progress/update-position/update-auto-row.ts"],"names":[],"mappings":"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","file":"update-auto-row.js","sourcesContent":["import { isValid } from '@visactor/vutils';\nimport type { BaseTableAPI } from '../../../../ts-types/base-table';\nimport type { Group } from '../../../graphic/group';\n\nexport function updateAutoRow(\n  colStart: number,\n  colEnd: number,\n  rowStart: number,\n  rowEnd: number,\n  table: BaseTableAPI,\n  direction: 'up' | 'down' = 'up',\n  part?: boolean\n) {\n  // return;\n  // 更新y位置\n  if (direction === 'up') {\n    for (let col = colStart; col <= colEnd; col++) {\n      for (let row = rowStart; row <= rowEnd; row++) {\n        const cellGroup = table.scenegraph.highPerformanceGetCell(col, row, true);\n        if (cellGroup.role !== 'cell' || !cellGroup.row) {\n          continue;\n        }\n        let y;\n        if (cellGroup._prev) {\n          // y = ((cellGroup._prev as Group)?.attribute.y ?? 0) + ((cellGroup._prev as Group)?.attribute.height ?? 0);\n          y = (cellGroup._prev as Group)?.attribute.y + table.getRowHeight((cellGroup._prev as Group).row);\n        } else if (part) {\n          const baseRowIndex = rowEnd === table.rowCount - table.bottomFrozenRowCount - 1 ? rowEnd : rowEnd + 1;\n          const baseCellGroup = table.scenegraph.highPerformanceGetCell(col, baseRowIndex, true);\n          y = baseCellGroup.attribute.y;\n          if (isValid(y)) {\n            for (let r = row; r < baseRowIndex; r++) {\n              y -= table.getRowHeight(r);\n            }\n          }\n        } else {\n          // 估计位置\n          y = getEstimatePosition(cellGroup.row, table);\n        }\n        if (isValid(y)) {\n          cellGroup.setAttribute('y', y);\n        }\n      }\n    }\n  } else {\n    for (let col = colStart; col <= colEnd; col++) {\n      for (let row = rowEnd; row >= rowStart; row--) {\n        const cellGroup = table.scenegraph.highPerformanceGetCell(col, row, true);\n        if (cellGroup.role !== 'cell' || !cellGroup.row) {\n          continue;\n        }\n        let y;\n        if (cellGroup._next) {\n          // y = ((cellGroup._next as Group)?.attribute.y ?? 0) - (cellGroup.attribute.height ?? 0);\n          y = (cellGroup._next as Group)?.attribute.y - table.getRowHeight(cellGroup.row);\n        } else if (part) {\n          const baseRowIndex = rowStart <= table.frozenRowCount ? table.frozenRowCount : rowStart - 1;\n          if (rowStart <= table.frozenRowCount) {\n            y = 0;\n          } else {\n            const baseCellGroup = table.scenegraph.highPerformanceGetCell(col, baseRowIndex, true);\n            y = baseCellGroup.attribute.y;\n          }\n          for (let r = baseRowIndex; r < row; r++) {\n            const height = table.getRowHeight(r);\n            y += height;\n          }\n        } else {\n          // 估计位置\n          y = getEstimatePosition(cellGroup.row, table);\n          // console.log('估计位置', table.getRowsHeight(table.frozenRowCount, cellGroup.row));\n        }\n        if (isValid(y)) {\n          cellGroup.setAttribute('y', y);\n        }\n      }\n    }\n  }\n\n  // update y limit in proxy\n  const totalActualBodyRowCount = Math.min(\n    table.scenegraph.proxy.rowLimit,\n    table.scenegraph.proxy.bodyBottomRow - table.scenegraph.proxy.bodyTopRow + 1\n  );\n  // 渐进加载总row数量\n  const totalBodyHeight = table.getRowsHeight(table.frozenRowCount, table.frozenRowCount + totalActualBodyRowCount);\n  const totalHeight = table.getRowsHeight(table.frozenRowCount, table.rowCount - 1);\n  table.scenegraph.proxy.yLimitTop = totalBodyHeight / 2;\n  table.scenegraph.proxy.yLimitBottom = totalHeight - totalBodyHeight / 2;\n\n  // // check\n  // const columnGroup = table.scenegraph.bodyGroup.firstChild;\n  // let y;\n  // columnGroup.forEachChildren(child => {\n  //   if (!isValid(y)) {\n  //     y = child.attribute.y + child.attribute.height;\n  //   } else if (child.attribute.y !== y) {\n  //     debugger;\n  //   }\n  //   y = child.attribute.y + child.attribute.height;\n  // });\n}\n\n// 获取预估位置\nfunction getEstimatePosition(row: number, table: BaseTableAPI) {\n  let y;\n  if (row < table.frozenRowCount) {\n    y = table.getRowsHeight(0, row - 1);\n  } else if (row >= table.rowCount - table.bottomFrozenRowCount) {\n    y = table.getRowsHeight(table.rowCount - table.bottomFrozenRowCount, row - 1);\n  } else {\n    y = table.getRowsHeight(table.frozenRowCount, row - 1);\n  }\n\n  return y;\n}\n"]}