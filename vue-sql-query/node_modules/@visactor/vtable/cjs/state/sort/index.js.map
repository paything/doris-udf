{"version":3,"sources":["../src/state/sort/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import { TABLE_EVENT_TYPE } from '../../core/TABLE_EVENT_TYPE';\nimport { defaultOrderFn } from '../../tools/util';\nimport type { ColumnDefine, HeaderData, HeaderDefine, ListTableAPI, SortState } from '../../ts-types';\nimport type { BaseTableAPI } from '../../ts-types/base-table';\n\n/**\n * @description: 执行sort\n * @param {number} col\n * @param {number} row\n * @param {BaseTableAPI} table\n * @return {*}\n */\nexport function dealSort(col: number, row: number, table: ListTableAPI, event: Event) {\n  //是击中的sort按钮才进行排序\n  let range1 = null;\n  let tableState: SortState;\n  let isTargetCell = false;\n  //找出当前表头是否在sortState排序规则中\n  if (Array.isArray(table.sortState)) {\n    for (let i = 0; i < table.sortState.length; i++) {\n      tableState = table.sortState[i];\n      if (tableState) {\n        range1 = table._getHeaderCellBySortState(tableState);\n      }\n      range1 && (isTargetCell = isTarget(col, row, range1.col, range1.row, table));\n      if (isTargetCell) {\n        break;\n      }\n    }\n  } else {\n    tableState = table.sortState;\n    if (tableState) {\n      range1 = table._getHeaderCellBySortState(tableState);\n    }\n    range1 && (isTargetCell = isTarget(col, row, range1.col, range1.row, table));\n  }\n\n  const headerC = table.getHeaderDefine(col, row) as ColumnDefine;\n  //当前排序规则是该表头field 且 表头设置了sort规则 需要转变sort的状态\n  if (tableState && isTargetCell && headerC?.sort) {\n    tableState.order = tableState.order === 'asc' ? 'desc' : tableState.order === 'desc' ? 'normal' : 'asc';\n  } else if (headerC?.sort) {\n    //如果当前表头设置了sort 则 转变sort的状态\n    tableState = {\n      field: <string>table.getHeaderField(col, row),\n      order: 'asc'\n    };\n  } else if (isTargetCell && headerC?.showSort) {\n    //当前排序规则是该表头field 且仅为显示showSort无sort 什么也不做\n  } else {\n    tableState = {\n      field: <string>table.getHeaderField(col, row),\n      order: 'normal'\n    };\n  }\n  (tableState as SortState & { event: Event }).event = event;\n  // 如果用户监听SORT_CLICK事件的回调函数返回false 则不执行内部排序逻辑\n  const sortEventReturns = table.fireListeners(TABLE_EVENT_TYPE.SORT_CLICK, tableState as SortState & { event: Event });\n  if (sortEventReturns.includes(false)) {\n    return;\n  }\n  let isArraySortState = false;\n  let sortState: SortState | SortState[] = table.internalProps.sortState\n    ? Array.isArray(table.internalProps.sortState) && (isArraySortState = true)\n      ? (table.internalProps.sortState as SortState[])\n      : [table.internalProps.sortState as SortState]\n    : [];\n  if (Array.isArray(sortState)) {\n    const index = (sortState as SortState[]).findIndex(item => item.field === tableState.field);\n    if (index >= 0) {\n      sortState[index] = tableState;\n    } else {\n      sortState.push(tableState);\n    }\n  }\n  sortState = (sortState as SortState[]).filter(item => item.order !== 'normal');\n  sortState = table.internalProps.multipleSort && (isArraySortState = true) ? sortState : sortState.splice(-1);\n  sortState = isArraySortState && sortState.length ? (sortState as SortState[]) : (sortState[0] as SortState);\n  table.internalProps.sortState = sortState; // 目前不支持多级排序 所以这里 直接赋值为单个sortState TODO优化（如果支持多级排序的话）\n  table.stateManager.setSortState(sortState);\n  if (headerC?.sort) {\n    executeSort(sortState, table, headerC);\n  }\n\n  // clear cell range cache\n  table.internalProps.useOneRowHeightFillAll = false;\n  table.internalProps.layoutMap.clearCellRangeMap();\n\n  table.scenegraph.sortCell();\n  // 排序后，清除选中效果\n  const isHasSelected = !!table.stateManager.select.ranges?.length;\n  table.stateManager.updateSelectPos(-1, -1);\n  table.stateManager.endSelectCells(true, isHasSelected);\n}\n\nfunction executeSort(newState: SortState | SortState[], table: BaseTableAPI, headerDefine: HeaderDefine): void {\n  newState = Array.isArray(newState) || !newState ? newState : [newState];\n  table.dataSource.sort(\n    ((newState || []) as Array<any>).map(item => {\n      const hd = table.internalProps.layoutMap.headerObjects.find((col: HeaderData) => col && col.field === item.field);\n      return {\n        field: item.field,\n        order: item.order || 'asc',\n        orderFn: typeof hd?.define?.sort === 'function' ? hd?.define?.sort : defaultOrderFn\n      };\n    })\n  );\n}\n\nfunction isTarget(col: number, row: number, range1Col: number, range1Row: number, table: BaseTableAPI): boolean {\n  return table._getLayoutCellId(col, row) === table._getLayoutCellId(range1Col, range1Row);\n}\n"]}