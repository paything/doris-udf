{"version":3,"sources":["../src/edit/edit-manager.ts"],"names":[],"mappings":"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","file":"edit-manager.js","sourcesContent":["import type { IEditor, ValidateEnum } from '@visactor/vtable-editors';\nimport { TABLE_EVENT_TYPE } from '../core/TABLE_EVENT_TYPE';\nimport type { BaseTableAPI } from '../ts-types/base-table';\nimport type { ListTableAPI } from '../ts-types';\nimport { getCellEventArgsSet } from '../event/util';\nimport type { SimpleHeaderLayoutMap } from '../layout';\nimport { isPromise } from '../tools/helper';\nimport { isValid } from '@visactor/vutils';\nimport type { IIconGraphicAttribute } from '../scenegraph/graphic/icon';\n\nexport class EditManager {\n  table: BaseTableAPI;\n  editingEditor: IEditor;\n  isValidatingValue: boolean = false;\n  editCell: { col: number; row: number };\n  listenersId: number[] = [];\n  beginTriggerEditCellMode: 'doubleclick' | 'click' | 'keydown';\n  constructor(table: BaseTableAPI) {\n    this.table = table;\n    this.bindEvent();\n  }\n\n  bindEvent() {\n    // const handler = this.table.internalProps.handler;\n    const table = this.table as ListTableAPI;\n    const doubleClickEventId = table.on(TABLE_EVENT_TYPE.DBLCLICK_CELL, e => {\n      const { editCellTrigger = 'doubleclick' } = table.options;\n\n      if (!editCellTrigger.includes('doubleclick')) {\n        return;\n      }\n\n      const { col, row } = e;\n\n      //取双击自动列宽逻辑\n      const eventArgsSet = getCellEventArgsSet(e.federatedEvent);\n      const resizeCol = table.scenegraph.getResizeColAt(\n        eventArgsSet.abstractPos.x,\n        eventArgsSet.abstractPos.y,\n        eventArgsSet.eventArgs?.targetCell\n      );\n      if (table._canResizeColumn(resizeCol.col, resizeCol.row) && resizeCol.col >= 0) {\n        // 判断同双击自动列宽的时间监听的DBLCLICK_CELL\n        // 如果是双击自动列宽 则编辑不开启\n        return;\n      }\n      if ((e.target?.attribute as IIconGraphicAttribute)?.funcType) {\n        // 点击功能图标不进入编辑\n        return;\n      }\n      this.beginTriggerEditCellMode = 'doubleclick';\n      this.startEditCell(col, row);\n    });\n\n    const clickEventId = table.on(TABLE_EVENT_TYPE.CLICK_CELL, e => {\n      const { editCellTrigger = 'doubleclick' } = table.options;\n      if (editCellTrigger === 'click' || (Array.isArray(editCellTrigger) && editCellTrigger.includes('click'))) {\n        if ((e.target?.attribute as IIconGraphicAttribute)?.funcType) {\n          // 点击功能图标不进入编辑\n          return;\n        }\n        this.beginTriggerEditCellMode = 'click';\n        const { col, row } = e;\n        this.startEditCell(col, row);\n      }\n    });\n\n    this.listenersId.push(doubleClickEventId, clickEventId);\n\n    // handler.on(this.table.getElement(), 'wheel', (e: WheelEvent) => {\n    //   this.completeEdit();\n    // });\n    // handler.on(this.table.getElement(), 'resize', (e: Event) => {\n    //   if (this.table.autoFillWidth || this.table.autoFillHeight) {\n    //     this.completeEdit();\n    //   }\n    // });\n  }\n\n  startEditCell(col: number, row: number, value?: string | number) {\n    if (this.editingEditor) {\n      return;\n    }\n    const editor = (this.table as ListTableAPI).getEditor(col, row);\n    if (editor) {\n      // //自定义内容单元格不允许编辑\n      // if (this.table.getCustomRender(col, row) || this.table.getCustomLayout(col, row)) {\n      //   console.warn(\"VTable Warn: cell has config custom render or layout, can't be edited\");\n      //   return;\n      // }\n      // if (!this.table.isHeader(col, row)) {\n      //   const range = this.table.getCellRange(col, row);\n      //   const isMerge = range.start.col !== range.end.col || range.start.row !== range.end.row;\n      //   if (isMerge) {\n      //     console.warn(\"VTable Warn: this is merge cell, can't be edited\");\n      //     return;\n      //   }\n      // }\n      if ((this.table.internalProps.layoutMap as SimpleHeaderLayoutMap)?.isAggregation?.(col, row)) {\n        console.warn(\"VTable Warn: this is aggregation value, can't be edited\");\n        return;\n      }\n\n      // group title cell do not allow edit\n      const record = this.table.getCellRawRecord(col, row);\n      if (record?.vtableMerge) {\n        console.warn(\"VTable Warn: this is group title, can't be edited\");\n        return;\n      }\n\n      if (!this.editingEditor) {\n        this.editCell = { col, row };\n      }\n\n      this.table._makeVisibleCell(col, row);\n      this.editingEditor = editor;\n      const dataValue = isValid(value) ? value : this.table.getCellOriginValue(col, row);\n      const rect = this.table.getCellRangeRelativeRect(this.table.getCellRange(col, row));\n      const referencePosition = { rect: { left: rect.left, top: rect.top, width: rect.width, height: rect.height } };\n\n      // adjust last col&row, same as packages/vtable/src/scenegraph/graphic/contributions/group-contribution-render.ts getCellSizeForDraw\n      if (col === this.table.colCount - 1) {\n        referencePosition.rect.width = rect.width - 1;\n      } else {\n        referencePosition.rect.width = rect.width + 1; // 这里的1应该根据单元格的borderWidth来定;\n      }\n      if (row === this.table.rowCount - 1) {\n        referencePosition.rect.height = rect.height - 1;\n      } else {\n        referencePosition.rect.height = rect.height + 1; // 这里的1应该根据单元格的borderWidth来定;\n      }\n\n      editor.beginEditing && console.warn('VTable Warn: `beginEditing` is deprecated, please use `onStart` instead.');\n      editor.beginEditing?.(this.table.getElement(), referencePosition, dataValue);\n\n      if (editor.bindSuccessCallback) {\n        console.warn('VTable Warn: `bindSuccessCallback` is deprecated, please use `onStart` instead.');\n      }\n      editor.bindSuccessCallback?.(() => {\n        this.completeEdit();\n      });\n      editor.onStart?.({\n        value: dataValue,\n        endEdit: () => {\n          this.completeEdit();\n        },\n        referencePosition,\n        container: this.table.getElement(),\n        col,\n        row,\n        table: this.table\n      });\n    }\n  }\n\n  /** 如果是鼠标事件触发调用该接口 请传入原始事件对象 将判断事件对象是否在编辑器本身上面  来处理是否结束编辑\n   * 返回值如果为false说明没有退出编辑状态  validateValue接口返回false 说明校验失败不退出编辑 */\n  completeEdit(e?: Event): boolean | Promise<boolean> {\n    if (!this.editingEditor) {\n      return true;\n    }\n    if (this.isValidatingValue) {\n      return false;\n    }\n    const target = e?.target as HTMLElement | undefined;\n    const { editingEditor: editor } = this;\n\n    if (target) {\n      if (editor.targetIsOnEditor) {\n        console.warn('VTable Warn: `targetIsOnEditor` is deprecated, please use `isEditorElement` instead.');\n\n        if (editor.targetIsOnEditor(target)) {\n          return false;\n        }\n      } else if (!editor.isEditorElement || editor.isEditorElement(target)) {\n        return false;\n      }\n    }\n\n    if (!this.editingEditor.getValue) {\n      console.warn('VTable Warn: `getValue` is not provided, did you forget to implement it?');\n    }\n    if (this.editingEditor.validateValue) {\n      this.isValidatingValue = true;\n      const newValue = this.editingEditor.getValue();\n      const oldValue = this.table.getCellOriginValue(this.editCell.col, this.editCell.row);\n\n      const maybePromiseOrValue = this.editingEditor.validateValue?.(newValue, oldValue, this.editCell, this.table);\n\n      if (isPromise(maybePromiseOrValue)) {\n        this.isValidatingValue = true;\n        return new Promise((resolve, reject) => {\n          maybePromiseOrValue\n            .then(result => {\n              // if (result) {\n              //   this.doExit();\n              //   resolve(true);\n              // } else {\n              //   this.isValidatingValue = false;\n              //   resolve(false);\n              // }\n              dealWithValidateValue(result, this, oldValue, resolve);\n            })\n            .catch((err: Error) => {\n              this.isValidatingValue = false;\n              console.error('VTable Error:', err);\n              reject(err);\n            });\n        });\n      }\n      return dealWithValidateValue(maybePromiseOrValue, this, oldValue);\n    }\n    this.doExit();\n    return true;\n  }\n\n  doExit() {\n    const changedValue = this.editingEditor.getValue?.();\n    const range = this.table.getCellRange(this.editCell.col, this.editCell.row);\n    const changedValues: any[] = [];\n    for (let row = range.start.row; row <= range.end.row; row++) {\n      const rowChangedValues = [];\n      for (let col = range.start.col; col <= range.end.col; col++) {\n        rowChangedValues.push(changedValue);\n      }\n      changedValues.push(rowChangedValues);\n    }\n    (this.table as ListTableAPI).changeCellValues(range.start.col, range.start.row, changedValues);\n    this.editingEditor.exit && console.warn('VTable Warn: `exit` is deprecated, please use `onEnd` instead.');\n    this.editingEditor.exit?.();\n    this.editingEditor.onEnd?.();\n    this.editingEditor = null;\n    this.isValidatingValue = false;\n    this.beginTriggerEditCellMode = null;\n  }\n\n  cancelEdit() {\n    if (this.editingEditor) {\n      // TODO: 添加开发时弃用警告\n      this.editingEditor.exit?.();\n      this.editingEditor.onEnd?.();\n      this.editingEditor = null;\n    }\n  }\n\n  release() {\n    this.listenersId.forEach(id => {\n      this.table.off(id);\n    });\n  }\n}\n\nfunction dealWithValidateValue(\n  validateValue: boolean | ValidateEnum,\n  editManager: EditManager,\n  oldValue: any,\n  resolve?: (value: boolean | PromiseLike<boolean>) => void\n): boolean {\n  editManager.isValidatingValue = false;\n  if (validateValue === 'validate-exit') {\n    editManager.doExit();\n    resolve?.(true);\n    return true;\n  } else if (validateValue === 'invalidate-exit') {\n    (editManager.editingEditor as any).setValue(oldValue);\n    editManager.doExit();\n    resolve?.(true);\n    return true;\n  } else if (validateValue === 'validate-not-exit') {\n    resolve?.(false);\n    return false;\n  } else if (validateValue === 'invalidate-not-exit') {\n    resolve?.(false);\n    return false;\n  } else if (validateValue === true) {\n    editManager.doExit();\n    resolve?.(true);\n    return true;\n  }\n  resolve?.(false);\n  return false;\n}\n"]}