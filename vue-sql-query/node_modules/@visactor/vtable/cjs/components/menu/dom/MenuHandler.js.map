{"version":3,"sources":["../src/components/menu/dom/MenuHandler.ts"],"names":[],"mappings":"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","file":"MenuHandler.js","sourcesContent":["import type { CellRange, DropDownMenuOptions, MenuInstanceInfo, MenuInstanceType } from '../../../ts-types';\nimport type { BaseMenu } from './BaseMenu';\nimport { Container, Menu } from './Menu';\nimport { cellInRange } from '../../../tools/helper';\nimport { TABLE_EVENT_TYPE } from '../../../core/TABLE_EVENT_TYPE';\nimport type { BaseTableAPI, HeaderData } from '../../../ts-types/base-table';\n// import { DEFAULTFONT } from '../../tools/global';\n// import { getFontSize } from '../../tools/canvases';\n\nconst MENU_INSTANCE_FACTORY = {\n  'dropdown-menu': function (table: BaseTableAPI): BaseMenu {\n    return new Menu(table);\n  },\n  'context-menu': function (table: BaseTableAPI): BaseMenu {\n    return new Menu(table);\n  },\n  container(table: BaseTableAPI): BaseMenu {\n    return new Container(table);\n  }\n};\n\n/** 获取下拉菜单展示内容及坐标位置 */\nfunction getMenuInstanceInfo(\n  table: BaseTableAPI,\n  col: number,\n  row: number,\n  type: MenuInstanceType,\n  dropDownMenuOptions?: DropDownMenuOptions\n): MenuInstanceInfo | null {\n  const { lineHeight, textBaseline, textStick } = table._getCellStyle(col, row);\n  // table.internalProps.layoutMap.getHeader(col, row).style ?? {};\n  // const lineHeight = getFontSize(table.getContext(), font).height;\n  let rect = table.getCellRangeRelativeRect(table.getCellRange(col, row));\n  if (textStick) {\n    rect = table.getVisibleCellRangeRelativeRect({ col, row });\n  }\n\n  let { left, right, bottom, top, width, height } = rect;\n  if (table.isHeader(col, row)) {\n    ({ left, right, bottom, top, width, height } = table.internalProps.headerHelper.getDropDownIconRect(\n      rect,\n      // paddingArray[1]\n      lineHeight as number,\n      textBaseline || 'middle'\n    ));\n  }\n  if (dropDownMenuOptions?.content) {\n    //如果有指定的下拉菜单内容\n    return {\n      type,\n      position: dropDownMenuOptions.position,\n      referencePosition: dropDownMenuOptions.referencePosition ?? {\n        rect: {\n          left,\n          right,\n          top,\n          bottom,\n          width,\n          height\n        }\n      },\n      content: dropDownMenuOptions.content\n    };\n  } // 没有指定的下拉菜单 从headerLayout中获取下拉菜单内容\n  else if (type === 'dropdown-menu') {\n    // 获取下拉菜单信息及位置 注：这里逻辑特指内置的下拉菜单\n    let dropDownMenu = table.globalDropDownMenu;\n    const headerData = table._getHeaderLayoutMap(col, row) as HeaderData;\n    dropDownMenu = headerData.dropDownMenu ?? dropDownMenu;\n    const pivotInfo = headerData.pivotInfo;\n\n    if (typeof dropDownMenu === 'function') {\n      dropDownMenu = dropDownMenu({ row, col, table });\n    }\n    // const x = (left + right) / 2;\n    // const y = bottom;\n\n    return {\n      type,\n      // position: {\n      //   x,\n      //   y,\n      // },\n      referencePosition: {\n        rect: {\n          left,\n          right,\n          top,\n          bottom,\n          width,\n          height\n        }\n      },\n      content: dropDownMenu,\n      pivotInfo\n    };\n  }\n  // else if (type === 'context-menu') {\n  //   // 获取右键菜单信息及位置\n  //   const abstractPos = table._getMouseAbstractPoint(event);\n  //   let menu = null;\n  //   if (abstractPos && typeof table.options.contextmenu === 'function') {\n  //     menu = table.options.contextmenu(table.getHeaderField(col, row) as string, row);\n  //   } else if (abstractPos && Array.isArray(table.options.contextmenu)) {\n  //     menu = table.options.contextmenu;\n  //   }\n  //   return {\n  //     position: {\n  //       x: abstractPos.x,\n  //       y: abstractPos.y,\n  //     },\n  //     type,\n  //     content: menu,\n  //   };\n  // }\n  return null;\n}\n\ntype AttachInfo = {\n  instance?: BaseMenu;\n  range: CellRange;\n};\n\nexport interface IMenuHandler {\n  new (table: BaseTableAPI): MenuHandler;\n}\nexport class MenuHandler {\n  private _table: BaseTableAPI;\n  private _menuInstances?: { [type: string]: BaseMenu };\n  private _attachInfo?: AttachInfo | null;\n  constructor(table: BaseTableAPI) {\n    this._table = table;\n    this._menuInstances = {};\n    this._bindTableEvent(table);\n  }\n  release(): void {\n    const menuInstances = this._menuInstances;\n    for (const k in menuInstances) {\n      menuInstances[k].release();\n    }\n    delete this._menuInstances;\n    this._attachInfo = null;\n  }\n  _bindToCell(col: number, row: number, type: MenuInstanceType, dropDownMenuOptions?: DropDownMenuOptions): void {\n    const info = this._attachInfo;\n    const instanceInfo = this._getMenuInstanceInfo(col, row, type, dropDownMenuOptions);\n    if (info && (!instanceInfo || info.instance !== instanceInfo.instance)) {\n      info.instance?.unbindMenuElement();\n      this._attachInfo = null;\n    }\n    if (!instanceInfo) {\n      return;\n    }\n    const { instance, info: menuInstanceInfo } = instanceInfo;\n    const attach = instance && instance.bindMenuElement(col, row, menuInstanceInfo);\n    if (attach) {\n      const range = this._table.getCellRange(col, row);\n      this._attachInfo = { range, instance };\n    }\n  }\n  _unbindFromCell(): void {\n    const info = this._attachInfo;\n    if (!info) {\n      return;\n    }\n    const { instance } = info;\n    instance?.unbindMenuElement();\n    this._attachInfo = null;\n    // this._table.showHoverIcon = undefined;\n  }\n  _isBindToCell(col: number, row: number): boolean {\n    const info = this._attachInfo;\n    if (!info) {\n      return false;\n    }\n    return cellInRange(info.range, col, row);\n  }\n  /** 鼠标坐标位置 是否位于下拉菜单内 */\n  pointInMenuElement(x: number, y: number) {\n    if (!this._attachInfo) {\n      return false;\n    }\n    const info = this._attachInfo;\n    const { instance } = info;\n    return instance.pointInMenuElement(x, y);\n  }\n  _bindTableEvent(table: BaseTableAPI): void {\n    // 监听按钮点击事件\n    // 三种情况：\n    // 1. 没有菜单，点击弹出菜单\n    // 2. 已显示菜单，点击关闭菜单\n    // 3. 已显示菜单，点击其他菜单按钮，关闭当前菜单，显示另一菜单\n    table.on(TABLE_EVENT_TYPE.DROPDOWN_ICON_CLICK, e => {\n      if (this._attachInfo) {\n        if (this._isBindToCell(e.col, e.row)) {\n          this._unbindFromCell();\n        } else {\n          this._bindToCell(e.col, e.row, 'dropdown-menu');\n        }\n      } else {\n        this._bindToCell(e.col, e.row, 'dropdown-menu');\n      }\n    });\n    // 监听菜单清除事件\n    table.on(TABLE_EVENT_TYPE.DROPDOWN_MENU_CLEAR, e => {\n      this._unbindFromCell();\n    });\n    // 监听右键菜单\n    table.on(TABLE_EVENT_TYPE.CONTEXTMENU_CELL, e => {\n      if (table.internalProps.menu?.renderMode === 'html') {\n        // 获取右键菜单信息及位置\n        const abstractPos = table._getMouseAbstractPoint(e.event);\n        let menu = null;\n        if (abstractPos.inTable && typeof table.internalProps.menu?.contextMenuItems === 'function') {\n          menu = table.internalProps.menu.contextMenuItems(\n            table.getHeaderField(e.col, e.row) as string,\n            e.row,\n            e.col,\n            table\n          );\n        } else if (abstractPos.inTable && Array.isArray(table.internalProps.menu?.contextMenuItems)) {\n          menu = table.internalProps.menu?.contextMenuItems;\n        }\n\n        this._bindToCell(e.col, e.row, 'context-menu', {\n          content: menu,\n          position: { x: abstractPos.x, y: abstractPos.y }\n        });\n      }\n    });\n  }\n  _getMenuInstanceInfo(\n    col: number,\n    row: number,\n    type: MenuInstanceType,\n    dropDownMenuOptions?: DropDownMenuOptions\n  ): {\n    instance?: BaseMenu;\n    type: MenuInstanceType;\n    info: MenuInstanceInfo;\n  } | null {\n    const table = this._table;\n    const menuInstances = this._menuInstances;\n\n    const info = getMenuInstanceInfo(table, col, row, type, dropDownMenuOptions);\n    if (!info) {\n      return null;\n    }\n\n    // const { type } = info;\n    const instance =\n      (menuInstances && menuInstances[type]) ||\n      (menuInstances && (menuInstances[type] = MENU_INSTANCE_FACTORY[type](table)));\n\n    return {\n      instance,\n      type,\n      info\n    };\n  }\n\n  containElement(el: HTMLElement): boolean {\n    for (const k in this._menuInstances) {\n      const contain = this._menuInstances[k].getRootElement()?.contains(el);\n      if (contain) {\n        return true;\n      }\n    }\n    return false;\n  }\n}\n"]}